# üöÄ H∆∞·ªõng D·∫´n To√†n Di·ªán V·ªÅ Combine Middleware Trong Zustand

Combine middleware trong Zustand l√† m·ªôt c√¥ng c·ª• √≠t ƒë∆∞·ª£c nh·∫Øc ƒë·∫øn nh∆∞ng r·∫•t h·ªØu √≠ch ƒë·ªÉ c·∫•u tr√∫c store m·ªôt c√°ch r√µ r√†ng, t√°ch bi·ªát gi·ªØa initial state v√† actions, gi√∫p code d·ªÖ ƒë·ªçc v√† maintain h∆°n trong d·ª± √°n l·ªõn. Chuy√™n ƒë·ªÅ n√†y t·∫≠p trung v√†o c√°c tr∆∞·ªùng h·ª£p th·ª±c t·∫ø, t·ª´ counter ƒë∆°n gi·∫£n ƒë·∫øn auth/cart k·∫øt h·ª£p, v√† pattern enterprise nh∆∞ module h√≥a root store. Ch√∫ng ta s·∫Ω ph√¢n t√≠ch c√°c v·∫•n ƒë·ªÅ th∆∞·ªùng g·∫∑p, nguy√™n nh√¢n, gi·∫£i ph√°p k√®m code m·∫´u, c√°c t√πy ch·ªçn n√¢ng cao, t√¨nh hu·ªëng th·ª±c t·∫ø, trade-off, best practices, k·ªãch b·∫£n bug, v√† c√°c demo k·∫øt h·ª£p v·ªõi persist/partialize.

---

## 1. ƒê·ªãnh Nghƒ©a V√† √ù T∆∞·ªüng Ch√≠nh

`Combine` middleware (`import { combine } from 'zustand/middleware'`) gi√∫p t√°ch bi·ªát:
- **Initial state:** Object ch·ª©a state ban ƒë·∫ßu.
- **Actions:** H√†m tr·∫£ v·ªÅ object ch·ª©a c√°c action (logic c·∫≠p nh·∫≠t state).

C√¥ng th·ª©c c∆° b·∫£n:
```ts
import { create } from "zustand";
import { combine } from "zustand/middleware";

export const useStore = create(
  combine(
    initialState,  // Object state ban ƒë·∫ßu
    (set, get) => actions  // H√†m tr·∫£ v·ªÅ object actions
  )
);
```

L·ª£i √≠ch ch√≠nh: Tr√°nh tr·ªôn l·∫´n state v√† actions trong m·ªôt object duy nh·∫•t, l√†m code r√µ r√†ng h∆°n, d·ªÖ scale cho team l·ªõn.

---

## 2. C√°c V·∫•n ƒê·ªÅ Th∆∞·ªùng G·∫∑p V√† Gi·∫£i Ph√°p

D∆∞·ªõi ƒë√¢y l√† c√°c v·∫•n ƒë·ªÅ ph·ªï bi·∫øn khi s·ª≠ d·ª•ng `combine`, k√®m ph√¢n t√≠ch nguy√™n nh√¢n v√† c√°ch kh·∫Øc ph·ª•c.

### 2.1. Code L·∫´n L·ªôn State/Actions
**V·∫•n ƒë·ªÅ:** State v√† actions tr·ªôn l·∫´n, kh√≥ ƒë·ªçc trong store l·ªõn.

**Nguy√™n nh√¢n:** C√°ch vi·∫øt m·∫∑c ƒë·ªãnh c·ªßa Zustand tr·ªôn chung.

**Gi·∫£i ph√°p:** S·ª≠ d·ª•ng `combine` ƒë·ªÉ t√°ch bi·ªát.

**Code sai (th∆∞·ªùng):**
```ts
create((set, get) => ({
  count: 0,  // State l·∫´n v·ªõi actions
  inc: () => set({ count: get().count + 1 }),
}));
```

**Code fix:**
```ts
create(
  combine(
    { count: 0 },  // State r√µ r√†ng
    (set, get) => ({
      inc: () => set({ count: get().count + 1 }),
    })
  )
);
```

### 2.2. Kh√≥ Maintain Khi Team L·ªõn
**V·∫•n ƒë·ªÅ:** Dev m·ªõi kh√≥ hi·ªÉu c·∫•u tr√∫c store.

**Nguy√™n nh√¢n:** Kh√¥ng t√°ch r√µ state/actions.

**Gi·∫£i ph√°p:** `Combine` gi√∫p ph√¢n chia, d·ªÖ onboard.

### 2.3. T√≠ch H·ª£p Persist Sai
**V·∫•n ƒë·ªÅ:** Persist kh√¥ng ho·∫°t ƒë·ªông ƒë√∫ng khi k·∫øt h·ª£p.

**Nguy√™n nh√¢n:** Th·ª© t·ª± middleware sai ho·∫∑c kh√¥ng partialize.

**Gi·∫£i ph√°p:** Wrap combine trong persist, d√πng partialize ƒë·ªÉ ch·ªçn field l∆∞u.

**Code m·∫´u:**
```ts
create(
  persist(
    combine(
      { user: null, loading: false },
      (set) => ({ login: () => { /* ... */ } })
    ),
    { name: "store", partialize: (state) => ({ user: state.user }) }
  )
);
```

### 2.4. State Transient Kh√¥ng ƒê∆∞·ª£c Persist
**V·∫•n ƒë·ªÅ:** L∆∞u nh·∫ßm state t·∫°m th·ªùi (loading, total).

**Nguy√™n nh√¢n:** Persist m·∫∑c ƒë·ªãnh l∆∞u h·∫øt.

**Gi·∫£i ph√°p:** Partialize ƒë·ªÉ lo·∫°i b·ªè transient fields.

### 2.5. Debug Kh√≥ V·ªõi Multi-Slice
**V·∫•n ƒë·ªÅ:** Root store l·ªõn, kh√≥ trace slice n√†o.

**Nguy√™n nh√¢n:** Kh√¥ng module h√≥a.

**Gi·∫£i ph√°p:** K·∫øt h·ª£p combine v·ªõi devtools, ƒë·∫∑t t√™n action theo slice (auth/login).

---

## 3. T√≥m T·∫Øt C√°c V·∫•n ƒê·ªÅ V√† Gi·∫£i Ph√°p

| V·∫•n ƒê·ªÅ                    | Nguy√™n Nh√¢n                          | Gi·∫£i Ph√°p                                   |
| ------------------------- | ------------------------------------ | ------------------------------------------- |
| Code l·∫´n l·ªôn state/actions| C√°ch vi·∫øt m·∫∑c ƒë·ªãnh                   | S·ª≠ d·ª•ng combine ƒë·ªÉ t√°ch                     |
| Kh√≥ maintain team l·ªõn     | Kh√¥ng c·∫•u tr√∫c r√µ                    | T√°ch state/actions, module h√≥a              |
| Persist sai               | Th·ª© t·ª± middleware ho·∫∑c l∆∞u h·∫øt       | Wrap ƒë√∫ng, partialize field c·∫ßn             |
| L∆∞u transient state       | Persist m·∫∑c ƒë·ªãnh                     | Partialize lo·∫°i b·ªè loading/total            |
| Debug multi-slice         | Store l·ªõn kh√¥ng trace r√µ             | K·∫øt h·ª£p devtools, t√™n action slice/action   |

---

## 4. Cheatsheet Combine Middleware

Combine kh√¥ng c√≥ option ph·ª©c t·∫°p, ch·ªâ c·∫ßn:

```ts
combine(
  initialState: Object,  // State ban ƒë·∫ßu
  actionsCreator: (set, get) => Object  // Actions
)
```

### Chi Ti·∫øt
- **initialState:** Object plain, kh√¥ng ch·ª©a functions (actions).
- **actionsCreator:** H√†m nh·∫≠n set/get, tr·∫£ v·ªÅ object actions (c√≥ th·ªÉ async).

### Trade-Off C·ªßa Combine

| Ti√™u Ch√≠         | C√°ch Th∆∞·ªùng | Combine            |
| ---------------- | ----------- | ------------------ |
| C√∫ ph√°p          | Ng·∫Øn h∆°n    | D√†i h∆°n m·ªôt ch√∫t   |
| ƒê·ªçc state/action | L·∫´n nhau    | R√µ r√†ng, t√°ch b·∫°ch |
| Team l·ªõn         | D·ªÖ nh·∫ßm l·∫´n | D·ªÖ ƒë·ªçc, d·ªÖ scale   |
| Debug            | B√¨nh th∆∞·ªùng | Clear ph√¢n chia    |

---

## 5. C√°c T√¨nh Hu·ªëng Th·ª±c T·∫ø

### 5.1. Counter Store
**V·∫•n ƒë·ªÅ:** State/actions l·∫´n l·ªôn.

**Code m·∫´u:**
```ts
create(
  combine(
    { count: 0 },
    (set, get) => ({
      inc: () => set({ count: get().count + 1 }),
      dec: () => set({ count: get().count - 1 }),
    })
  )
);
```

### 5.2. Auth Store
```ts
type User = { id: number; name: string } | null;

create(
  combine(
    { user: null as User, loading: false },
    (set) => ({
      login: async (name: string) => {
        set({ loading: true });
        await new Promise((r) => setTimeout(r, 1000));
        set({ user: { id: Date.now(), name }, loading: false });
      },
      logout: () => set({ user: null }),
    })
  )
);
```

### 5.3. Cart Store
**V·∫•n ƒë·ªÅ:** Persist l∆∞u nh·∫ßm total/discount.

**Code m·∫´u:**
```ts
type CartItem = { id: number; name: string; price: number; qty: number };

create(
  persist(
    combine(
      { items: [] as CartItem[], total: 0, discount: 0 },
      (set, get) => ({
        addItem: (item: Omit<CartItem, "id">) => {
          const newItem = { ...item, id: Date.now() };
          set((state) => {
            const updatedItems = [...state.items, newItem];
            return {
              items: updatedItems,
              total: updatedItems.reduce((sum, it) => sum + it.price * it.qty, 0),
            };
          });
        },
        removeItem: (id: number) => {
          set((state) => {
            const updatedItems = state.items.filter((i) => i.id !== id);
            return {
              items: updatedItems,
              total: updatedItems.reduce((sum, it) => sum + it.price * it.qty, 0),
            };
          });
        },
        clearCart: () => set({ items: [], total: 0, discount: 0 }),
        applyDiscount: (percent: number) => {
          set((state) => ({
            discount: state.total * (percent / 100),
          });
        },
      })
    ),
    {
      name: "cart-storage",
      partialize: (state) => ({ items: state.items }),  // Ch·ªâ l∆∞u items
    }
  )
);
```

**S·ª≠ d·ª•ng:**
```tsx
const { items, total, discount, addItem, removeItem, clearCart, applyDiscount } = useCartStore();

<button onClick={() => addItem({ name: "Sofa", price: 1000, qty: 1 })}>Add</button>
<p>Total: ${total - discount}</p>
```

---

## 6. K·ªãch B·∫£n Bug Th∆∞·ªùng G·∫∑p V·ªõi Combine

### 6.1. Actions Kh√¥ng ƒê∆∞·ª£c Export
**V·∫•n ƒë·ªÅ:** Qu√™n export actions trong actionsCreator.

**Code sai:**
```ts
combine(
  { count: 0 },
  (set) => { inc: () => {} }  // Sai: kh√¥ng return object
);
```

**Code fix:**
```ts
combine(
  { count: 0 },
  (set) => ({ inc: () => {} })
);
```

### 6.2. Persist L∆∞u Actions
**V·∫•n ƒë·ªÅ:** Persist l∆∞u nh·∫ßm actions (functions).

**Gi·∫£i ph√°p:** Partialize lo·∫°i b·ªè functions.

### 6.3. Second Order Middleware Sai
**V·∫•n ƒë·ªÅ:** Combine trong persist sai th·ª© t·ª±.

**Code fix:** Combine trong persist.

### 6.4. State Kh√¥ng Update
**V·∫•n ƒë·ªÅ:** Mutate state kh√¥ng ƒë√∫ng trong actions.

**Gi·∫£i ph√°p:** K·∫øt h·ª£p immer n·∫øu nested state.

### 6.5. Multi-Slice Tr√πng T√™n
**V·∫•n ƒë·ªÅ:** Slice t√™n tr√πng trong root store.

**Gi·∫£i ph√°p:** Prefix slice (auth_token, cart_items).

---

## 7. Trade-Off & Best Practices C·ªßa Combine

### 7.1. ∆Øu ƒêi·ªÉm
1. **R√µ R√†ng:** T√°ch state/actions, d·ªÖ ƒë·ªçc.
2. **D·ªÖ Scale:** Ph√π h·ª£p team l·ªõn, multi-slice.
3. **K·∫øt H·ª£p T·ªët:** V·ªõi persist (l∆∞u state), devtools (trace actions).

### 7.2. Nh∆∞·ª£c ƒêi·ªÉm
1. **C√∫ Ph√°p D√†i H∆°n:** Th√™m v√†i d√≤ng so v·ªõi c√°ch th∆∞·ªùng.
2. **Kh√¥ng Linh Ho·∫°t V·ªõi Non-Object State:** Initial state ph·∫£i object.
3. **Partialize C·∫ßn C·∫©n Th·∫≠n:** Khi persist, d·ªÖ qu√™n lo·∫°i transient fields.

### 7.3. Best Practices
1. **T√°ch Slice R√µ:** Prefix state/actions theo module (auth_, cart_).
2. **Partialize Khi Persist:** Ch·ªâ l∆∞u persistent data.
3. **K·∫øt H·ª£p Immer:** N·∫øu nested state, wrap immer trong combine.
4. **Devtools:** ƒê·∫∑t t√™n action slice/action (auth/login).
5. **Root Store Cho Multi-Slice:** Merge slices v√†o m·ªôt store cho ƒë·ªìng b·ªô.

---

## 8. Demo: Root Store (Auth + Cart V·ªõi Combine + Persist + Partialize)

```ts
import { create } from "zustand";
import { combine, persist } from "zustand/middleware";

type User = { id: number; name: string } | null;

type CartItem = { id: number; name: string; price: number; qty: number };

type RootState = {
  token: string | null;
  user: User;
  items: CartItem[];
  login: (token: string, user: { id: number; name: string }) => void;
  logout: () => void;
  addItem: (item: Omit<CartItem, "id">) => void;
  removeItem: (id: number) => void;
  clearCart: () => void;
};

export const useStore = create<RootState>()(
  persist(
    combine(
      {
        token: null,
        user: null,
        items: [],
      },
      (set, get) => ({
        login: (token, user) => set({ token, user }),
        logout: () => set({ token: null, user: null, items: [] }),
        addItem: (item) => {
          const newItem = { ...item, id: Date.now() };
          set({ items: [...get().items, newItem] });
        },
        removeItem: (id) => {
          set({ items: get().items.filter((i) => i.id !== id) });
        },
        clearCart: () => set({ items: [] }),
      })
    ),
    {
      name: "root-storage",
      partialize: (state) => ({
        token: state.token,
        user: state.user,
        items: state.items,
      }),
    }
  )
);
```

**S·ª≠ d·ª•ng:**
```tsx
const { token, user, login, logout, items, addItem, removeItem, clearCart } = useStore();

<button onClick={() => login("token-123", { id: 1, name: "User" })}>Login</button>
<ul>{items.map((i) => <li>{i.name} <button onClick={() => removeItem(i.id)}>Remove</button></li>)}</ul>
```

**ƒêi·ªÉm M·∫°nh:** Multi-slice trong root store, persist selective, d·ªÖ m·ªü r·ªông.

**Trade-Off:** Root store ti·ªán ƒë·ªìng b·ªô nh∆∞ng c√≥ th·ªÉ re-render th·ª´a n·∫øu kh√¥ng selector.

---

## 9. T·ªïng K·∫øt

`Combine` gi√∫p c·∫•u tr√∫c store r√µ r√†ng, d·ªÖ maintain, ƒë·∫∑c bi·ªát khi k·∫øt h·ª£p persist/partialize cho auth/cart. Trade-off: C√∫ ph√°p d√†i h∆°n nh∆∞ng ƒë√°ng gi√° cho project l·ªõn.

**Case th·ª±c t·∫ø:** Counter, auth, cart, root store ƒë·ªÅu h∆∞·ªüng l·ª£i t·ª´ combine.

---

üìå [<< Ng√†y 05 E SubscribeWithSelector](./Day05-E-SubscribeWithSelector.md) | [Ng√†y 05 G Custom-Middleware >>](./Day05-G-Custom-Middleware.md)
