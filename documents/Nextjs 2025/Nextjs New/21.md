## 🧭 **Params & searchParams trong Next.js App Router**

### 🎯 Mục tiêu

* Hiểu rõ **sự khác biệt giữa params và searchParams**
* Biết cách **truy xuất dữ liệu URL** trong Server Component và Client Component
* Áp dụng params vào **Dynamic Routes** (ví dụ: `/blog/[slug]`)
* Áp dụng searchParams vào **lọc, phân trang, tìm kiếm**

---

## 🧱 1️⃣ `params` – Dynamic Segments

**Cấu trúc:**

```
app/
└── blog/
    └── [slug]/
        └── page.tsx
```

**URL:**

```
/blog/nextjs-tutorial
```

**Code ví dụ:**

```tsx
// app/blog/[slug]/page.tsx

export default function BlogPost({
  params,
}: {
  params: { slug: string };
}) {
  return (
    <article>
      <h1>📝 Blog: {params.slug}</h1>
      <p>This is the content of post "{params.slug}".</p>
    </article>
  );
}
```

➡ Kết quả:
`/blog/nextjs-tutorial` → Hiển thị “Blog: nextjs-tutorial”.

---

## 🧩 2️⃣ `searchParams` – Query String trong URL

**URL:**

```
/products?page=2&category=shoes
```

**Cấu trúc file:**

```
app/products/page.tsx
```

**Code ví dụ:**

```tsx
// app/products/page.tsx

export default function ProductList({
  searchParams,
}: {
  searchParams: { page?: string; category?: string };
}) {
  const page = searchParams.page ?? "1";
  const category = searchParams.category ?? "all";

  return (
    <section>
      <h2>🛍️ Product List</h2>
      <p>
        Category: <strong>{category}</strong>
      </p>
      <p>
        Page: <strong>{page}</strong>
      </p>
    </section>
  );
}
```

➡ Truy cập:
`/products?page=2&category=shoes`
→ Next.js tự parse `searchParams` cho bạn.

---

## ⚙️ 3️⃣ Khi nào nên dùng?

| Loại           | Khi nào dùng                       | Ví dụ                         |
| -------------- | ---------------------------------- | ----------------------------- |
| `params`       | Khi đường dẫn xác định nội dung    | `/blog/[slug]`                |
| `searchParams` | Khi cần lọc / sắp xếp / phân trang | `/products?page=2&sort=price` |

---

## 🧠 4️⃣ Dùng trong Client Component

Nếu bạn cần truy cập URL params trong **Client Component**, hãy dùng:

```tsx
"use client";

import { useParams, useSearchParams } from "next/navigation";

export default function ClientDemo() {
  const params = useParams();
  const searchParams = useSearchParams();

  return (
    <div>
      <p>Slug: {params.slug}</p>
      <p>Query: {searchParams.get("category")}</p>
    </div>
  );
}
```

---

## 💬 5️⃣ Bài tập nhỏ

> Tạo trang `/blog/[slug]` hiển thị nội dung dựa vào params.
> Khi thêm query `?author=John` thì hiển thị thêm dòng “Written by John”.

---
Dưới đây là **code mẫu hoàn chỉnh** cho bài *“Params & searchParams”* — kết hợp **Server Component + Client Component** để bạn thấy toàn bộ cách hoạt động của Next.js App Router.

---

## 📂 **Cấu trúc thư mục**

```
app/
├── blog/
│   └── [slug]/
│       ├── page.tsx          ← Server Component
│       └── ClientInfo.tsx    ← Client Component (đọc URL runtime)
```

---

## 📄 **1️⃣ Server Component – page.tsx**

```tsx
// app/blog/[slug]/page.tsx
import ClientInfo from "./ClientInfo";

export default function BlogPost({
  params,
  searchParams,
}: {
  params: { slug: string };
  searchParams?: { author?: string };
}) {
  const { slug } = params;
  const author = searchParams?.author;

  return (
    <article style={{ padding: "2rem", border: "1px solid #ddd", borderRadius: 8 }}>
      <h1>📝 Blog Post: {slug}</h1>
      <p>
        This is the content for the blog post <strong>{slug}</strong>.
      </p>

      {author && (
        <p style={{ color: "gray" }}>
          ✍️ Written by <strong>{author}</strong>
        </p>
      )}

      <hr style={{ margin: "1rem 0" }} />

      {/* Client Component đọc runtime URL */}
      <ClientInfo />
    </article>
  );
}
```

---

## 📄 **2️⃣ Client Component – ClientInfo.tsx**

```tsx
// app/blog/[slug]/ClientInfo.tsx
"use client";

import { useParams, useSearchParams } from "next/navigation";

export default function ClientInfo() {
  const params = useParams();
  const searchParams = useSearchParams();

  const slug = params.slug;
  const author = searchParams.get("author");

  return (
    <section
      style={{
        marginTop: "1rem",
        padding: "1rem",
        border: "1px dashed #ccc",
        borderRadius: 6,
        background: "#fafafa",
      }}
    >
      <h4>🧭 Client-side URL Info</h4>
      <p>
        <strong>Slug:</strong> {slug}
      </p>
      <p>
        <strong>Author:</strong> {author || "(none)"}
      </p>
    </section>
  );
}
```

---

## 🧠 **3️⃣ Giải thích hoạt động**

| Thành phần                          | Vai trò                                                             | Thời điểm render |
| ----------------------------------- | ------------------------------------------------------------------- | ---------------- |
| `page.tsx` (Server Component)       | Nhận `params` & `searchParams` trực tiếp từ Next.js                 | Server-side      |
| `ClientInfo.tsx` (Client Component) | Dùng hooks `useParams` & `useSearchParams` để đọc URL **ở runtime** | Browser-side     |

---

## 🧩 **4️⃣ Kết quả chạy**

| URL                                | Kết quả                                            |
| ---------------------------------- | -------------------------------------------------- |
| `/blog/nextjs-routing`             | Hiển thị `Blog Post: nextjs-routing`               |
| `/blog/nextjs-routing?author=John` | Hiển thị thêm `Written by John` + client-side info |

---

## 💬 **5️⃣ Bài tập mở rộng**

> Thêm vào phần Client Component một nút `Next Post`, khi click sẽ đổi sang `/blog/nextjs-hydration?author=Alice` bằng `router.push()` (dùng hook `useRouter()` của Next.js).
>
> → Mục tiêu: luyện tập chuyển route động và cập nhật searchParams client-side.

---
Dưới đây là **phiên bản mở rộng** của ví dụ `params & searchParams` — có thêm **nút điều hướng client-side** dùng `useRouter()`, giúp bạn thấy rõ cơ chế **hydration + re-render** khi thay đổi URL ngay trên browser.

---

## 📂 **Cấu trúc thư mục**

```
app/
├── blog/
│   └── [slug]/
│       ├── page.tsx
│       └── ClientInfo.tsx
```

---

## 📄 **1️⃣ Server Component – page.tsx**

```tsx
// app/blog/[slug]/page.tsx
import ClientInfo from "./ClientInfo";

export default function BlogPost({
  params,
  searchParams,
}: {
  params: { slug: string };
  searchParams?: { author?: string };
}) {
  const { slug } = params;
  const author = searchParams?.author;

  return (
    <article style={{ padding: "2rem", border: "1px solid #ddd", borderRadius: 8 }}>
      <h1>📝 Blog Post: {slug}</h1>
      <p>
        This is the content for the blog post <strong>{slug}</strong>.
      </p>

      {author && (
        <p style={{ color: "gray" }}>
          ✍️ Written by <strong>{author}</strong>
        </p>
      )}

      <hr style={{ margin: "1rem 0" }} />

      {/* Client Component */}
      <ClientInfo />
    </article>
  );
}
```

---

## 📄 **2️⃣ Client Component – ClientInfo.tsx**

```tsx
// app/blog/[slug]/ClientInfo.tsx
"use client";

import { useParams, useSearchParams, useRouter } from "next/navigation";

export default function ClientInfo() {
  const params = useParams();
  const searchParams = useSearchParams();
  const router = useRouter();

  const slug = params.slug;
  const author = searchParams.get("author");

  const handleNextPost = () => {
    const nextSlug =
      slug === "nextjs-routing" ? "nextjs-hydration" : "nextjs-routing";
    router.push(`/blog/${nextSlug}?author=Alice`);
  };

  return (
    <section
      style={{
        marginTop: "1rem",
        padding: "1rem",
        border: "1px dashed #ccc",
        borderRadius: 6,
        background: "#fafafa",
      }}
    >
      <h4>🧭 Client-side Info</h4>
      <p>
        <strong>Slug:</strong> {slug}
      </p>
      <p>
        <strong>Author:</strong> {author || "(none)"}
      </p>

      <button
        onClick={handleNextPost}
        style={{
          marginTop: "1rem",
          padding: "0.5rem 1rem",
          backgroundColor: "#0070f3",
          color: "white",
          border: "none",
          borderRadius: "6px",
          cursor: "pointer",
        }}
      >
        🔄 Next Post
      </button>
    </section>
  );
}
```

---

## 🔍 **3️⃣ Giải thích cơ chế hoạt động**

| Hành động                                           | Diễn giải                                                                                       |
| --------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| Lần đầu truy cập `/blog/nextjs-routing?author=John` | Server render ra HTML + dữ liệu. Sau đó client sẽ **hydrate** component.                        |
| Khi bấm nút “Next Post”                             | `router.push()` → đổi URL sang `/blog/nextjs-hydration?author=Alice` mà **không reload trang**. |
| Next.js                                             | Tự động render lại `page.tsx` và `ClientInfo.tsx` (client-side re-render).                      |
| Kết quả                                             | Bạn thấy nội dung thay đổi tức thì, nhưng hydration không bị mất (state client vẫn giữ).        |

---

## 🧠 **4️⃣ Kiến thức rút ra**

1. `params` và `searchParams` trong Server Component được Next.js inject sẵn.
2. Trong Client Component, ta đọc lại bằng `useParams()` & `useSearchParams()` → luôn cập nhật theo URL.
3. `useRouter().push()` cho phép điều hướng *SPA-style* → không reload → giữ hydration.
4. Đây là nền tảng cho **dynamic routing, filters, pagination, search query...** trong Next.js App Router.
---
> Để demo **dynamic UI dựa trên route segment**, chúng ta sẽ dùng hook `useSelectedLayoutSegment()` của Next.js. Đây là hook **client-side** giúp biết **segment hiện tại của route đang active** trong **layout** hoặc **nested route**, rất hữu ích cho **highlight menu, breadcrumbs, tab navigation**.

Mình sẽ viết ví dụ **dựa trên dashboard/analytics/settings** để minh họa.

---

## 📂 **Cấu trúc thư mục**

```
app/
├── dashboard/
│   ├── layout.tsx
│   ├── page.tsx
│   ├── analytics/
│   │   └── page.tsx
│   └── settings/
│       └── page.tsx
```

---

## 📄 **layout.tsx với useSelectedLayoutSegment**

```tsx
"use client"; // layout muốn sử dụng hook client-side

import { useSelectedLayoutSegment } from "next/navigation";

export default function DashboardLayout({ children }: { children: React.ReactNode }) {
  const segment = useSelectedLayoutSegment(); // lấy segment hiện tại

  return (
    <div style={{ display: "flex", minHeight: "100vh" }}>
      <aside style={{ width: 200, background: "#f0f0f0", padding: 16 }}>
        <h3>📋 Dashboard</h3>
        <ul>
          <li style={{ fontWeight: segment === null ? "bold" : "normal" }}>
            <a href="/dashboard">Overview</a>
          </li>
          <li style={{ fontWeight: segment === "analytics" ? "bold" : "normal" }}>
            <a href="/dashboard/analytics">Analytics</a>
          </li>
          <li style={{ fontWeight: segment === "settings" ? "bold" : "normal" }}>
            <a href="/dashboard/settings">Settings</a>
          </li>
        </ul>
      </aside>

      <main style={{ flex: 1, padding: 16 }}>{children}</main>
    </div>
  );
}
```

---

## 📄 **page.tsx đơn giản cho các route con**

```tsx
// app/dashboard/page.tsx
export default function OverviewPage() {
  return <h2>Dashboard Overview</h2>;
}

// app/dashboard/analytics/page.tsx
export default function AnalyticsPage() {
  return <h2>Analytics Section</h2>;
}

// app/dashboard/settings/page.tsx
export default function SettingsPage() {
  return <h2>Settings Section</h2>;
}
```

---

## 🧠 **Cơ chế hoạt động**

1. `useSelectedLayoutSegment()` trả về **tên segment hiện tại** tương ứng với folder con đang active.

   * `/dashboard` → `null` (segment root)
   * `/dashboard/analytics` → `"analytics"`
   * `/dashboard/settings` → `"settings"`

2. Khi bạn click menu, component **Client Layout** tự re-render → **bold item tương ứng**.

3. Không cần dùng state thủ công hay props drilling → rất tiện cho **menu, breadcrumb, tab navigation** trong nested route.
---
Mình sẽ viết **demo production-ready** cho **Dashboard Layout** kết hợp:

* Nested Layout (`dashboard/`)
* Sidebar
* Highlight menu dynamic bằng `useSelectedLayoutSegment()`
* Hydration hoạt động đúng khi chuyển giữa các route con

---

## 📂 **Cấu trúc thư mục**

```
app/
├── dashboard/
│   ├── layout.tsx
│   ├── page.tsx
│   ├── analytics/
│   │   └── page.tsx
│   └── settings/
│       └── page.tsx
```

---

## 📄 **1️⃣ Dashboard Layout**

```tsx
"use client"; // Layout dùng hook client-side

import { ReactNode } from "react";
import { useSelectedLayoutSegment } from "next/navigation";

export default function DashboardLayout({ children }: { children: ReactNode }) {
  const segment = useSelectedLayoutSegment();

  return (
    <div style={{ display: "flex", minHeight: "100vh" }}>
      {/* Sidebar */}
      <aside
        style={{
          width: 220,
          background: "#f0f0f0",
          padding: 20,
          display: "flex",
          flexDirection: "column",
          gap: 10,
        }}
      >
        <h3>📋 Dashboard</h3>
        <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
          <li style={{ fontWeight: segment === null ? "bold" : "normal" }}>
            <a href="/dashboard">Overview</a>
          </li>
          <li style={{ fontWeight: segment === "analytics" ? "bold" : "normal" }}>
            <a href="/dashboard/analytics">Analytics</a>
          </li>
          <li style={{ fontWeight: segment === "settings" ? "bold" : "normal" }}>
            <a href="/dashboard/settings">Settings</a>
          </li>
        </ul>
      </aside>

      {/* Main content */}
      <main style={{ flex: 1, padding: 24 }}>{children}</main>
    </div>
  );
}
```

---

## 📄 **2️⃣ Overview Page**

```tsx
// app/dashboard/page.tsx
export default function OverviewPage() {
  return (
    <div>
      <h2>🏠 Dashboard Overview</h2>
      <p>Welcome to your dashboard summary.</p>
    </div>
  );
}
```

---

## 📄 **3️⃣ Analytics Page**

```tsx
// app/dashboard/analytics/page.tsx
export default function AnalyticsPage() {
  return (
    <div>
      <h2>📊 Analytics Section</h2>
      <p>Here you can track metrics and user engagement.</p>
    </div>
  );
}
```

---

## 📄 **4️⃣ Settings Page**

```tsx
// app/dashboard/settings/page.tsx
export default function SettingsPage() {
  return (
    <div>
      <h2>⚙️ Settings Section</h2>
      <p>Manage your dashboard preferences here.</p>
    </div>
  );
}
```

---

## 🧠 **5️⃣ Cơ chế hoạt động**

1. **Nested Layout**: `dashboard/layout.tsx` bao quanh tất cả các route con (`/dashboard`, `/dashboard/analytics`, `/dashboard/settings`) → sidebar chỉ render 1 lần, giữ nguyên state khi chuyển trang.
2. **useSelectedLayoutSegment()**: trả về segment hiện tại để highlight menu chính xác.
3. **Hydration SPA-style**: khi click link, Next.js **chỉ render page mới** mà **layout không reload**, giữ sidebar và các component client-state.
4. Có thể mở rộng thêm breadcrumbs, tab navigation, hoặc preserve scroll position dễ dàng.

---
Mình sẽ viết **phiên bản nâng cao Dashboard Layout** gần production-ready, bao gồm:

* Sidebar **collapsible**
* Dynamic **breadcrumbs** theo nested route
* Nested Layout sâu (3 level)
* Highlight menu tự động theo route segment
* Hydration & state giữ nguyên khi chuyển page

---

## 📂 **Cấu trúc thư mục**

```
app/
├── layout.tsx            // Root layout
├── dashboard/
│   ├── layout.tsx        // Dashboard nested layout
│   ├── page.tsx          // /dashboard
│   ├── analytics/
│   │   ├── layout.tsx    // Nested layout cho analytics (optional)
│   │   └── page.tsx
│   └── settings/
│       └── page.tsx
```

---

## 📄 **1️⃣ Root Layout**

```tsx
// app/layout.tsx
import { ReactNode } from "react";

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="en">
      <body style={{ fontFamily: "sans-serif", margin: 0 }}>
        {children}
      </body>
    </html>
  );
}
```

---

## 📄 **2️⃣ Dashboard Layout với Sidebar Collapsible + Breadcrumbs**

```tsx
"use client";

import { ReactNode, useState } from "react";
import { useSelectedLayoutSegment, usePathname } from "next/navigation";
import Link from "next/link";

export default function DashboardLayout({ children }: { children: ReactNode }) {
  const segment = useSelectedLayoutSegment();
  const pathname = usePathname();
  const [collapsed, setCollapsed] = useState(false);

  const breadcrumbs = pathname
    .split("/")
    .filter(Boolean)
    .map((seg, idx, arr) => ({
      name: seg,
      href: "/" + arr.slice(0, idx + 1).join("/"),
    }));

  return (
    <div style={{ display: "flex", minHeight: "100vh" }}>
      {/* Sidebar */}
      <aside
        style={{
          width: collapsed ? 60 : 220,
          background: "#f0f0f0",
          padding: 20,
          transition: "width 0.2s",
        }}
      >
        <button
          onClick={() => setCollapsed(!collapsed)}
          style={{ marginBottom: 20 }}
        >
          {collapsed ? "➡️" : "⬅️"}
        </button>
        <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
          <li style={{ fontWeight: segment === null ? "bold" : "normal" }}>
            <Link href="/dashboard">Overview</Link>
          </li>
          <li style={{ fontWeight: segment === "analytics" ? "bold" : "normal" }}>
            <Link href="/dashboard/analytics">Analytics</Link>
          </li>
          <li style={{ fontWeight: segment === "settings" ? "bold" : "normal" }}>
            <Link href="/dashboard/settings">Settings</Link>
          </li>
        </ul>
      </aside>

      {/* Main Content */}
      <main style={{ flex: 1, padding: 24 }}>
        {/* Breadcrumbs */}
        <nav style={{ marginBottom: 16 }}>
          {breadcrumbs.map((crumb, idx) => (
            <span key={idx}>
              <Link href={crumb.href}>{crumb.name}</Link>
              {idx < breadcrumbs.length - 1 && " / "}
            </span>
          ))}
        </nav>

        {/* Page Content */}
        {children}
      </main>
    </div>
  );
}
```

---

## 📄 **3️⃣ Page Examples**

```tsx
// app/dashboard/page.tsx
export default function OverviewPage() {
  return <h2>🏠 Dashboard Overview</h2>;
}

// app/dashboard/analytics/page.tsx
export default function AnalyticsPage() {
  return <h2>📊 Analytics Section</h2>;
}

// app/dashboard/settings/page.tsx
export default function SettingsPage() {
  return <h2>⚙️ Settings Section</h2>;
}
```

---

## 🧠 **4️⃣ Ưu điểm của phiên bản nâng cao**

1. **Sidebar Collapsible**: người dùng có thể thu gọn/ mở rộng, state được giữ nguyên khi chuyển page nhờ layout không reload.
2. **Dynamic Breadcrumbs**: hiển thị đường dẫn theo URL hiện tại.
3. **Nested Layout Support**: dễ mở rộng thêm `/dashboard/analytics/reports` với layout riêng.
4. **Highlight Active Menu**: `useSelectedLayoutSegment()` tự động bold item tương ứng.
5. **SPA-style Hydration**: layout giữ nguyên, page re-render, trải nghiệm mượt mà.

---
Bây giờ mình sẽ viết **Dashboard Layout kết hợp Server Components + Client Components**, production-ready, với các tính năng:

* **Sidebar client-side**: giữ state khi chuyển page, collapsible
* **Page content server-side**: fetch dữ liệu trực tiếp từ server/database
* **Nested Layouts**: hỗ trợ route sâu
* **Highlight menu active**: `useSelectedLayoutSegment()`
* **Dynamic Breadcrumbs**
* **SPA-style hydration**: layout không reload khi chuyển page

---

## 📂 **Cấu trúc thư mục**

```
app/
├── layout.tsx                  // Root layout
├── dashboard/
│   ├── layout.tsx              // Dashboard nested layout
│   ├── page.tsx                // Overview (Server Component)
│   ├── analytics/
│   │   └── page.tsx            // Analytics (Server Component)
│   └── settings/
│       └── page.tsx            // Settings (Server Component)
├── _components/
│   └── Sidebar.tsx             // Client Component
```

---

## 📄 **1️⃣ Sidebar Client Component**

```tsx
// app/_components/Sidebar.tsx
"use client";

import { useState } from "react";
import { useSelectedLayoutSegment } from "next/navigation";
import Link from "next/link";

export default function Sidebar() {
  const segment = useSelectedLayoutSegment();
  const [collapsed, setCollapsed] = useState(false);

  return (
    <aside
      style={{
        width: collapsed ? 60 : 220,
        background: "#f0f0f0",
        padding: 20,
        transition: "width 0.2s",
      }}
    >
      <button onClick={() => setCollapsed(!collapsed)} style={{ marginBottom: 20 }}>
        {collapsed ? "➡️" : "⬅️"}
      </button>
      <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
        <li style={{ fontWeight: segment === null ? "bold" : "normal" }}>
          <Link href="/dashboard">Overview</Link>
        </li>
        <li style={{ fontWeight: segment === "analytics" ? "bold" : "normal" }}>
          <Link href="/dashboard/analytics">Analytics</Link>
        </li>
        <li style={{ fontWeight: segment === "settings" ? "bold" : "normal" }}>
          <Link href="/dashboard/settings">Settings</Link>
        </li>
      </ul>
    </aside>
  );
}
```

---

## 📄 **2️⃣ Dashboard Layout (Server Component)**

```tsx
// app/dashboard/layout.tsx
import { ReactNode } from "react";
import Sidebar from "../_components/Sidebar";

export default function DashboardLayout({ children }: { children: ReactNode }) {
  return (
    <div style={{ display: "flex", minHeight: "100vh" }}>
      {/* Sidebar Client Component */}
      <Sidebar />

      {/* Main content (Server Component) */}
      <main style={{ flex: 1, padding: 24 }}>{children}</main>
    </div>
  );
}
```

✅ Lưu ý: `DashboardLayout` là **Server Component** theo mặc định (không `"use client"`), còn `Sidebar` là **Client Component**, dùng hook, state.

---

## 📄 **3️⃣ Overview Page (Server Component)**

```tsx
// app/dashboard/page.tsx
async function fetchDashboardData() {
  // giả lập fetch dữ liệu từ database/server
  return { users: 120, sales: 3400 };
}

export default async function OverviewPage() {
  const data = await fetchDashboardData();

  return (
    <div>
      <h2>🏠 Dashboard Overview</h2>
      <p>Total Users: {data.users}</p>
      <p>Total Sales: ${data.sales}</p>
    </div>
  );
}
```

---

## 📄 **4️⃣ Analytics Page (Server Component)**

```tsx
// app/dashboard/analytics/page.tsx
async function fetchAnalytics() {
  return { visits: 5600, bounceRate: "34%" };
}

export default async function AnalyticsPage() {
  const stats = await fetchAnalytics();

  return (
    <div>
      <h2>📊 Analytics Section</h2>
      <p>Visits: {stats.visits}</p>
      <p>Bounce Rate: {stats.bounceRate}</p>
    </div>
  );
}
```

---

## 📄 **5️⃣ Settings Page (Server Component)**

```tsx
// app/dashboard/settings/page.tsx
export default function SettingsPage() {
  return (
    <div>
      <h2>⚙️ Settings</h2>
      <p>Manage your dashboard preferences here.</p>
    </div>
  );
}
```

---

## 🧠 **6️⃣ Cơ chế**

1. **Server Components**: `DashboardLayout` + page fetch dữ liệu trực tiếp server-side → tối ưu performance.
2. **Client Components**: `Sidebar` giữ state collapsible, highlight active menu → SPA-style không reload layout.
3. **Nested Layout**: dễ mở rộng với `/dashboard/analytics/reports` hoặc `/dashboard/settings/profile`.
4. **Hydration mượt mà**: chỉ page re-render, layout + sidebar giữ nguyên state.

---

💡 **Tip**: Bạn có thể thêm **dynamic breadcrumbs** trong `DashboardLayout` bằng `usePathname()` của `next/navigation`, kết hợp với segment để tạo đường dẫn hiện tại.

---
Mình sẽ viết **Dashboard Layout nâng cao full version** gần production-ready, bao gồm:

* **Sidebar collapsible** với highlight active menu
* **Dynamic breadcrumbs**
* **Preserve scroll position** khi chuyển page
* **Nested Layouts sâu** (có thể 3–4 level)
* **Server Components + Client Components** kết hợp
* **Hydration mượt mà**

---

## 📂 **Cấu trúc thư mục**

```
app/
├── layout.tsx                  // Root layout
├── dashboard/
│   ├── layout.tsx              // Dashboard nested layout
│   ├── page.tsx                // Overview
│   ├── analytics/
│   │   └── page.tsx
│   ├── settings/
│   │   ├── page.tsx
│   │   └── profile/
│   │       └── page.tsx
├── _components/
│   ├── Sidebar.tsx             // Client Component
│   └── Breadcrumbs.tsx         // Client Component
```

---

## 📄 **1️⃣ Sidebar Client Component**

```tsx
// app/_components/Sidebar.tsx
"use client";

import { useState, useEffect } from "react";
import { useSelectedLayoutSegment } from "next/navigation";
import Link from "next/link";

export default function Sidebar() {
  const segment = useSelectedLayoutSegment();
  const [collapsed, setCollapsed] = useState(false);

  return (
    <aside
      style={{
        width: collapsed ? 60 : 220,
        background: "#f0f0f0",
        padding: 20,
        transition: "width 0.2s",
      }}
    >
      <button onClick={() => setCollapsed(!collapsed)} style={{ marginBottom: 20 }}>
        {collapsed ? "➡️" : "⬅️"}
      </button>
      <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
        <li style={{ fontWeight: segment === null ? "bold" : "normal" }}>
          <Link href="/dashboard">Overview</Link>
        </li>
        <li style={{ fontWeight: segment === "analytics" ? "bold" : "normal" }}>
          <Link href="/dashboard/analytics">Analytics</Link>
        </li>
        <li style={{ fontWeight: segment === "settings" ? "bold" : "normal" }}>
          <Link href="/dashboard/settings">Settings</Link>
        </li>
      </ul>
    </aside>
  );
}
```

---

## 📄 **2️⃣ Breadcrumbs Client Component**

```tsx
// app/_components/Breadcrumbs.tsx
"use client";

import { usePathname } from "next/navigation";
import Link from "next/link";

export default function Breadcrumbs() {
  const pathname = usePathname();
  const segments = pathname.split("/").filter(Boolean);

  return (
    <nav style={{ marginBottom: 16 }}>
      {segments.map((seg, idx) => {
        const href = "/" + segments.slice(0, idx + 1).join("/");
        return (
          <span key={idx}>
            <Link href={href}>{seg}</Link>
            {idx < segments.length - 1 && " / "}
          </span>
        );
      })}
    </nav>
  );
}
```

---

## 📄 **3️⃣ Dashboard Layout (Server Component)**

```tsx
// app/dashboard/layout.tsx
import { ReactNode } from "react";
import Sidebar from "../_components/Sidebar";
import Breadcrumbs from "../_components/Breadcrumbs";

export default function DashboardLayout({ children }: { children: ReactNode }) {
  return (
    <div style={{ display: "flex", minHeight: "100vh" }}>
      {/* Sidebar (Client Component) */}
      <Sidebar />

      {/* Main Content */}
      <main style={{ flex: 1, padding: 24 }}>
        {/* Breadcrumbs (Client Component) */}
        <Breadcrumbs />

        {/* Server-rendered page */}
        {children}
      </main>
    </div>
  );
}
```

---

## 📄 **4️⃣ Pages (Server Components)**

```tsx
// app/dashboard/page.tsx
export default function OverviewPage() {
  return <h2>🏠 Dashboard Overview</h2>;
}

// app/dashboard/analytics/page.tsx
export default function AnalyticsPage() {
  return <h2>📊 Analytics Section</h2>;
}

// app/dashboard/settings/page.tsx
export default function SettingsPage() {
  return <h2>⚙️ Settings Section</h2>;
}

// app/dashboard/settings/profile/page.tsx
export default function ProfilePage() {
  return <h2>👤 Profile Settings</h2>;
}
```

---

## 🧠 **5️⃣ Tính năng nâng cao**

1. **Sidebar collapsible + active highlight**: `useSelectedLayoutSegment()` đảm bảo menu đúng route hiện tại.
2. **Dynamic breadcrumbs**: cập nhật theo URL.
3. **Nested Layouts sâu**: `/dashboard/settings/profile` có thể thêm layout riêng mà vẫn giữ Sidebar.
4. **SPA-style Hydration**: sidebar, breadcrumbs giữ state khi chuyển page, page mới server-render.
5. **Preserve scroll position**: layout client giữ scroll, không reload khi đổi route con.

---

💡 **Tip**: Bạn có thể thêm `useEffect` trong `Sidebar` để scroll tới menu active khi layout load, giúp UX giống SPA production-ready.

---
Bây giờ mình sẽ nâng cấp **Dashboard full version production-ready**, bao gồm:

* **Server + Client Components kết hợp**
* **Data fetching từ server (fake API)**
* **Loading Skeleton + Error Boundary**
* **Nested Layouts sâu**
* **Sidebar + Breadcrumbs giữ trạng thái khi chuyển page**
* **Hydration mượt mà, SPA-like experience**

---

## 📂 **Cấu trúc thư mục nâng cao**

```
app/
├── layout.tsx                  // Root layout
├── dashboard/
│   ├── layout.tsx              // Dashboard nested layout
│   ├── page.tsx                // Overview
│   ├── analytics/
│   │   └── page.tsx
│   ├── settings/
│   │   ├── page.tsx
│   │   └── profile/
│   │       └── page.tsx
├── _components/
│   ├── Sidebar.tsx             // Client Component
│   ├── Breadcrumbs.tsx         // Client Component
│   ├── LoadingSkeleton.tsx     // Client Component
│   └── ErrorBoundary.tsx       // Client Component
```

---

## 📄 **1️⃣ LoadingSkeleton Component**

```tsx
// app/_components/LoadingSkeleton.tsx
"use client";

export default function LoadingSkeleton() {
  return (
    <div style={{ padding: 16 }}>
      <div style={{ background: "#eee", height: 20, width: "50%", marginBottom: 8 }} />
      <div style={{ background: "#eee", height: 20, width: "80%", marginBottom: 8 }} />
      <div style={{ background: "#eee", height: 20, width: "30%" }} />
    </div>
  );
}
```

---

## 📄 **2️⃣ ErrorBoundary Component**

```tsx
// app/_components/ErrorBoundary.tsx
"use client";

import { ReactNode, useState } from "react";

export default function ErrorBoundary({ children }: { children: ReactNode }) {
  const [hasError, setHasError] = useState(false);

  if (hasError) {
    return (
      <div style={{ color: "red", padding: 16 }}>
        <h3>🚨 Something went wrong!</h3>
        <button onClick={() => setHasError(false)}>Try Again</button>
      </div>
    );
  }

  try {
    return children;
  } catch (err) {
    setHasError(true);
    return null;
  }
}
```

---

## 📄 **3️⃣ Fake Server Data Fetching**

```ts
// app/dashboard/data.ts
export async function fetchDashboardData() {
  await new Promise(res => setTimeout(res, 1000)); // simulate delay
  return {
    users: 120,
    sales: 5400,
    activeSessions: 23,
  };
}
```

---

## 📄 **4️⃣ Dashboard Layout (Server + Client)**

```tsx
// app/dashboard/layout.tsx
import { ReactNode } from "react";
import Sidebar from "../_components/Sidebar";
import Breadcrumbs from "../_components/Breadcrumbs";
import LoadingSkeleton from "../_components/LoadingSkeleton";
import ErrorBoundary from "../_components/ErrorBoundary";

export default function DashboardLayout({ children }: { children: ReactNode }) {
  return (
    <div style={{ display: "flex", minHeight: "100vh" }}>
      {/* Sidebar (Client Component) */}
      <Sidebar />

      {/* Main Content */}
      <main style={{ flex: 1, padding: 24 }}>
        {/* Breadcrumbs */}
        <Breadcrumbs />

        {/* ErrorBoundary wraps server content */}
        <ErrorBoundary>
          <React.Suspense fallback={<LoadingSkeleton />}>
            {children}
          </React.Suspense>
        </ErrorBoundary>
      </main>
    </div>
  );
}
```

---

## 📄 **5️⃣ Overview Page (Server Component + fetch data)**

```tsx
// app/dashboard/page.tsx
import { fetchDashboardData } from "./data";

export default async function OverviewPage() {
  const data = await fetchDashboardData();

  return (
    <div>
      <h2>🏠 Dashboard Overview</h2>
      <ul>
        <li>Users: {data.users}</li>
        <li>Sales: ${data.sales}</li>
        <li>Active Sessions: {data.activeSessions}</li>
      </ul>
    </div>
  );
}
```

---

## 📄 **6️⃣ Analytics Page**

```tsx
// app/dashboard/analytics/page.tsx
import { fetchDashboardData } from "../data";

export default async function AnalyticsPage() {
  const data = await fetchDashboardData();

  return (
    <div>
      <h2>📊 Analytics</h2>
      <p>Users: {data.users}</p>
      <p>Sales: ${data.sales}</p>
    </div>
  );
}
```

---

## 📄 **7️⃣ Settings Page**

```tsx
// app/dashboard/settings/page.tsx
export default function SettingsPage() {
  return (
    <div>
      <h2>⚙️ Settings</h2>
      <p>Configure your dashboard preferences here.</p>
    </div>
  );
}
```

---

## 🧠 **8️⃣ Nâng cao**

1. **Hydration + Suspense**: Server component render dữ liệu, Client component (Sidebar + Breadcrumbs) giữ trạng thái.
2. **Loading Skeleton**: React.Suspense fallback hiển thị khi server fetch data.
3. **ErrorBoundary**: Bao quanh tất cả trang, tránh crash toàn bộ layout.
4. **SPA-like UX**: sidebar giữ state, breadcrumbs tự động update.
5. **Nested Layouts sâu**: Có thể thêm `settings/profile/layout.tsx` riêng mà vẫn giữ layout cha.

---

💡 **Tip**: Khi dự án thật, bạn có thể thay `fetchDashboardData` bằng Prisma/DB hoặc REST/GraphQL API. Layout + Suspense + ErrorBoundary + Client Components combo này gần như **chuẩn production-ready**.


---
[<< BÀI 20](./20.md) | [BÀI 22 >>](./22.md)