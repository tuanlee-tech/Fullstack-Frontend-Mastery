## ğŸ§­ Error Handling trong Next.js

### ğŸ¯ Má»¥c tiÃªu

* Hiá»ƒu cÃ¡ch Next.js **quáº£n lÃ½ lá»—i trong App Router**.
* Biáº¿t cÃ¡ch táº¡o **error boundaries** cho tá»«ng route, layout hoáº·c toÃ n app.
* Cáº£i thiá»‡n tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng khi xáº£y ra lá»—i.

---

## ğŸ§± 1ï¸âƒ£ CÆ¡ cháº¿ cÆ¡ báº£n

* Trong App Router, báº¡n cÃ³ thá»ƒ táº¡o **file `error.tsx`** trong **báº¥t ká»³ thÆ° má»¥c route nÃ o**.
* Khi route con hoáº·c layout Ä‘Ã³ gáº·p lá»—i, **Next.js tá»± Ä‘á»™ng render `error.tsx`** thay vÃ¬ crash toÃ n bá»™ app.

```
app/
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ error.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
```

* `/dashboard/error.tsx` sáº½ Ä‘Æ°á»£c render náº¿u `page.tsx` hoáº·c component con trong dashboard throw error.

---

## ğŸ§© 2ï¸âƒ£ VÃ­ dá»¥ Error Component

```tsx
// app/dashboard/error.tsx
"use client";

import { useEffect } from "react";

interface ErrorProps {
  error: Error;
  reset: () => void;
}

export default function DashboardError({ error, reset }: ErrorProps) {
  useEffect(() => {
    console.error("Dashboard error:", error);
  }, [error]);

  return (
    <div style={{ padding: "2rem", color: "red" }}>
      <h2>Something went wrong in Dashboard!</h2>
      <p>{error.message}</p>
      <button onClick={() => reset()}>Try Again</button>
    </div>
  );
}
```

* `reset()` sáº½ **reset error boundary** vÃ  thá»­ render láº¡i page/layout.
* Chá»‰ **component lá»—i + layout lá»—i** bá»‹ thay tháº¿, khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n cÃ¡c layout khÃ¡c.

---

## ğŸ§± 3ï¸âƒ£ Nested Error Handling

```
app/
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ error.tsx
â”‚   â””â”€â”€ analytics/
â”‚       â””â”€â”€ error.tsx
```

* Lá»—i trong `/dashboard/analytics` sáº½ render **analytics/error.tsx**, náº¿u khÃ´ng cÃ³ â†’ fallback lÃªn **dashboard/error.tsx**.
* Lá»—i toÃ n cá»¥c â†’ render **root app/error.tsx**.

---

## ğŸ’¡ 4ï¸âƒ£ NguyÃªn táº¯c

* Táº¡o **error.tsx** á»Ÿ má»—i layer náº¿u muá»‘n handle riÃªng
* **Root error.tsx** lÃ  fallback cuá»‘i cÃ¹ng
* Káº¿t há»£p vá»›i **loading.tsx** cho UX mÆ°á»£t mÃ 


---

# ğŸš¨ Má»Ÿ Rá»™ng: Error Handling 

## ğŸ§­ Tá»•ng Quan

Trong **App Router**, Next.js triá»ƒn khai **Error Boundaries** á»Ÿ **má»©c route segment** â€” nghÄ©a lÃ  má»—i thÆ° má»¥c trong `app/` cÃ³ thá»ƒ tá»± Ä‘á»‹nh nghÄ©a cÃ¡ch xá»­ lÃ½ lá»—i riÃªng mÃ  khÃ´ng lÃ m crash toÃ n bá»™ á»©ng dá»¥ng.

Äiá»u nÃ y ráº¥t máº¡nh vÃ¬ báº¡n cÃ³ thá»ƒ:

* CÃ´ láº­p lá»—i á»Ÿ tá»«ng khu vá»±c (vÃ­ dá»¥: `dashboard`, `auth`, `profile`).
* Cung cáº¥p tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng mÆ°á»£t mÃ  hÆ¡n (render fallback UI thay vÃ¬ mÃ n hÃ¬nh tráº¯ng).
* Ghi log lá»—i riÃªng cho tá»«ng pháº§n.

---

## âš™ï¸ 1ï¸âƒ£ Cáº¥u trÃºc chuáº©n

```tsx
app/
â”œâ”€â”€ layout.tsx
â”œâ”€â”€ error.tsx        // error boundary toÃ n cá»¥c
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ error.tsx    // error boundary riÃªng cho dashboard
â”‚   â””â”€â”€ page.tsx
â””â”€â”€ auth/
    â”œâ”€â”€ layout.tsx
    â”œâ”€â”€ error.tsx    // error boundary riÃªng cho auth
    â””â”€â”€ login/page.tsx
```

---

## ğŸ§± 2ï¸âƒ£ `error.tsx` hoáº¡t Ä‘á»™ng ra sao

Khi component hoáº·c page con cá»§a route Ä‘Ã³ **throw error (runtime hoáº·c render error)**, Next.js sáº½:

1. **Dá»«ng render cÃ¢y component con**.
2. **Unmount** táº¥t cáº£ component con (náº¿u cÃ³).
3. **Render `error.tsx`** cá»§a segment gáº§n nháº¥t (local boundary).
4. Náº¿u khÃ´ng cÃ³, fallback dáº§n lÃªn **layout cha**, **rá»“i root error.tsx**.

---

## ğŸ§© 3ï¸âƒ£ VÃ­ dá»¥ chuyÃªn sÃ¢u

```tsx
// app/dashboard/error.tsx
"use client";
import { useEffect } from "react";

export default function DashboardError({
  error,
  reset,
}: {
  error: Error;
  reset: () => void;
}) {
  useEffect(() => {
    console.error("ğŸš¨ Dashboard Error:", error);
    // VÃ­ dá»¥: gá»­i log lÃªn Sentry hoáº·c backend
    // Sentry.captureException(error);
  }, [error]);

  return (
    <div className="p-8 text-red-600">
      <h2>âš ï¸ Dashboard Crashed!</h2>
      <p>{error.message}</p>
      <button
        onClick={() => reset()}
        className="mt-4 px-4 py-2 bg-blue-500 text-white rounded"
      >
        Try again
      </button>
    </div>
  );
}
```

ğŸ§  **Giáº£i thÃ­ch:**

* `error`: lÃ  instance cá»§a `Error` mÃ  component con nÃ©m ra.
* `reset()`: dÃ¹ng Ä‘á»ƒ â€œthá»­ render láº¡iâ€ sau khi user thá»±c hiá»‡n thao tÃ¡c (vÃ­ dá»¥ click â€œTry againâ€).
* `error.tsx` pháº£i lÃ  **Client Component** (`"use client"`) vÃ¬ nÃ³ dÃ¹ng hook.
* KhÃ´ng cáº§n bá»c báº±ng `try/catch` á»Ÿ component con â€” Next.js tá»± xá»­ lÃ½.

---

## ğŸ” 4ï¸âƒ£ Káº¿t há»£p vá»›i `loading.tsx` vÃ  `not-found.tsx`

* `loading.tsx`: dÃ¹ng khi Ä‘ang chá» dá»¯ liá»‡u (Suspense fallback).
* `error.tsx`: dÃ¹ng khi cÃ³ lá»—i xáº£y ra trong quÃ¡ trÃ¬nh render hoáº·c data fetching.
* `not-found.tsx`: dÃ¹ng khi router khÃ´ng tÃ¬m tháº¥y page phÃ¹ há»£p.

ğŸ§© VÃ­ dá»¥ káº¿t há»£p ba file:

```
app/
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ loading.tsx
â”‚   â”œâ”€â”€ error.tsx
â”‚   â”œâ”€â”€ not-found.tsx
â”‚   â””â”€â”€ page.tsx
```

Luá»“ng hoáº¡t Ä‘á»™ng:

1. Khi page Ä‘ang load â†’ render `loading.tsx`.
2. Náº¿u data invalid hoáº·c fetch tháº¥t báº¡i â†’ render `error.tsx`.
3. Náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u hoáº·c URL sai â†’ render `not-found.tsx`.

---

## ğŸ§° 5ï¸âƒ£ Error trong Server Components

Next.js tá»± Ä‘á»™ng **bá»c Server Components trong error boundary cha gáº§n nháº¥t**.
Tuy nhiÃªn, **khÃ´ng thá»ƒ dÃ¹ng hook (useEffect, useState)** trong `error.tsx` server â€” vÃ¬ file Ä‘Ã³ pháº£i lÃ  **Client Component** náº¿u báº¡n muá»‘n dÃ¹ng logic.

Náº¿u báº¡n muá»‘n log lá»—i á»Ÿ server-side:

```tsx
// app/error.tsx
"use client";
export default function GlobalError({ error }: { error: Error }) {
  console.error("SSR Error logged:", error);
  return <h2>Global Error: {error.message}</h2>;
}
```

VÃ  thÃªm logging tháº­t trong **middleware**, **server actions** hoáº·c **API routes**.

---

## ğŸ§  6ï¸âƒ£ Best Practices (Production-Ready)

âœ… Táº¡o error.tsx riÃªng cho tá»«ng vÃ¹ng quan trá»ng (auth, dashboard, productâ€¦).
âœ… Ghi log lá»—i vá» backend/Sentry thay vÃ¬ console.log.
âœ… Cho phÃ©p user **retry hoáº·c quay láº¡i trang chá»§**.
âœ… Káº¿t há»£p **error.tsx** + **loading.tsx** + **not-found.tsx** cho UX liá»n máº¡ch.
âœ… DÃ¹ng `reset()` Ä‘á»ƒ refresh state nháº¹ (khÃ´ng reload toÃ n trang).
âœ… DÃ¹ng **root error.tsx** lÃ m fallback cuá»‘i cÃ¹ng (UI nháº¹, khÃ´ng cáº§u ká»³).

---

## ğŸ§ª 7ï¸âƒ£ Bonus: VÃ­ dá»¥ lá»—i thá»±c táº¿

```tsx
// app/dashboard/page.tsx
export default async function Page() {
  const res = await fetch("https://api.fakeurl.io/data");
  if (!res.ok) {
    throw new Error("API failed: " + res.statusText);
  }

  const data = await res.json();
  return <pre>{JSON.stringify(data, null, 2)}</pre>;
}
```

â¡ï¸ Khi API lá»—i â†’ render tá»± Ä‘á»™ng `app/dashboard/error.tsx`.

---


DÆ°á»›i Ä‘Ã¢y lÃ  pháº§n **"Advanced Error Handling"** â€“ dÃ nh cho báº¡n á»Ÿ má»©c **Senior / Enterprise-level**, Ã¡p dá»¥ng cho cÃ¡c tÃ¬nh huá»‘ng thá»±c táº¿ khi lÃ m viá»‡c vá»›i **Server Actions, API Routes, Middleware vÃ  Logging Services (Sentry, Datadog, v.v.)**.

---

# âš¡ï¸ Error Handling NÃ¢ng Cao Trong Next.js (App Router)

## ğŸ¯ Má»¥c tiÃªu

* Hiá»ƒu cÃ¡ch xá»­ lÃ½ lá»—i **á»Ÿ má»i táº§ng** trong Next.js (client, server, API, middleware).
* Biáº¿t cÃ¡ch **ghi log**, **phÃ¢n loáº¡i lá»—i**, **thÃ´ng bÃ¡o ngÆ°á»i dÃ¹ng** Ä‘Ãºng cÃ¡ch.
* Thiáº¿t káº¿ há»‡ thá»‘ng **error boundary nháº¥t quÃ¡n** cho á»©ng dá»¥ng lá»›n (SaaS, dashboard, v.v.)

---

## ğŸ§© 1ï¸âƒ£ PhÃ¢n loáº¡i lá»—i trong App Router

| Loáº¡i lá»—i                | Xáº£y ra á»Ÿ Ä‘Ã¢u                          | CÃ¡ch handle                                |
| ----------------------- | ------------------------------------- | ------------------------------------------ |
| **Render Error**        | React Component (client/server)       | `error.tsx`                                |
| **Data Fetching Error** | `fetch()`, `getData()`, Server Action | `try/catch` hoáº·c `error.tsx`               |
| **Not Found**           | Route khÃ´ng khá»›p / data rá»—ng          | `not-found.tsx` hoáº·c `notFound()`          |
| **Server Action Error** | Function cháº¡y trong server            | `try/catch` hoáº·c propagate lÃªn `error.tsx` |
| **Middleware Error**    | `middleware.ts`                       | `try/catch` + `NextResponse.redirect()`    |
| **API Route Error**     | `route.ts`                            | `try/catch` + tráº£ JSON lá»—i chuáº©n hÃ³a       |

---

## ğŸ§± 2ï¸âƒ£ Error trong **Server Action**

Server Action cháº¡y trÃªn server (giá»‘ng function trong API), nÃªn pháº£i dÃ¹ng `try/catch` cá»¥c bá»™ â€” vÃ¬ lá»—i khÃ´ng thá»ƒ bubble lÃªn client tá»± Ä‘á»™ng.

```tsx
// app/actions/createUser.ts
"use server";

import { revalidatePath } from "next/cache";

export async function createUser(formData: FormData) {
  try {
    const email = formData.get("email");
    if (!email) throw new Error("Missing email");

    await db.user.create({ data: { email } });
    revalidatePath("/dashboard");
  } catch (error) {
    console.error("âŒ Server Action Error:", error);
    throw new Error("Unable to create user"); // nÃ©m ra error.tsx á»Ÿ layer tÆ°Æ¡ng á»©ng
  }
}
```

> ğŸ§  Máº¹o: Khi muá»‘n gá»­i thÃ´ng bÃ¡o lá»—i UI thay vÃ¬ crash, báº¡n cÃ³ thá»ƒ tráº£ giÃ¡ trá»‹ `return { error: "..." }` thay vÃ¬ throw.

---

## ğŸ§­ 3ï¸âƒ£ Error trong **route.ts (API Route)**

Dáº¡ng API route trong App Router:

```tsx
// app/api/users/route.ts
import { NextResponse } from "next/server";

export async function GET() {
  try {
    const users = await db.user.findMany();
    return NextResponse.json(users);
  } catch (error) {
    console.error("API Error:", error);
    return NextResponse.json(
      { message: "Internal Server Error" },
      { status: 500 }
    );
  }
}
```

> âœ… **Best practice:** LuÃ´n tráº£ lá»—i JSON chuáº©n, kÃ¨m status code rÃµ rÃ ng (400/401/404/500).
> âœ… CÃ³ thá»ƒ log thÃªm `error.stack` náº¿u cháº¡y trong mÃ´i trÆ°á»ng development.

---

## ğŸ§© 4ï¸âƒ£ Error trong **middleware.ts**

Middleware cháº¡y á»Ÿ edge, nÃªn khÃ´ng cÃ³ error boundary.
CÃ¡ch duy nháº¥t lÃ  **try/catch thá»§ cÃ´ng** + redirect sang trang lá»—i:

```ts
// middleware.ts
import { NextResponse } from "next/server";

export async function middleware(req) {
  try {
    const token = req.cookies.get("token");
    if (!token) throw new Error("Unauthorized");

    return NextResponse.next();
  } catch (error) {
    console.error("Middleware Error:", error);
    return NextResponse.redirect(new URL("/error", req.url));
  }
}
```

---

## ğŸ§± 5ï¸âƒ£ Error Logging vÃ  Monitoring (Production)

á» production, **console.log khÃ´ng Ä‘á»§**.
Báº¡n nÃªn tÃ­ch há»£p 1 trong cÃ¡c service logging sau:

| Service                      | Má»¥c Ä‘Ã­ch                                  | Æ¯u Ä‘iá»ƒm                  |
| ---------------------------- | ----------------------------------------- | ------------------------ |
| ğŸ§  **Sentry**                | Ghi log lá»—i runtime, theo dÃµi stack trace | TÃ­ch há»£p sÃ¢u vá»›i Next.js |
| ğŸ”¥ **Datadog**               | GiÃ¡m sÃ¡t hiá»‡u nÄƒng + log lá»—i              | DÃ nh cho enterprise      |
| ğŸ“ˆ **Logtail / BetterStack** | Gá»n nháº¹, dá»… setup                         | PhÃ¹ há»£p startup          |

### VÃ­ dá»¥ tÃ­ch há»£p Sentry

1ï¸âƒ£ CÃ i:

```bash
npm install @sentry/nextjs
npx sentry wizard -i nextjs
```

2ï¸âƒ£ Ghi log trong error.tsx hoáº·c server action:

```tsx
import * as Sentry from "@sentry/nextjs";

export function MyError({ error }: { error: Error }) {
  useEffect(() => {
    Sentry.captureException(error);
  }, [error]);
}
```

> Khi lá»—i xáº£y ra, Sentry lÆ°u **stack trace, user info, route** â†’ dá»… debug.

---

## ğŸ§­ 6ï¸âƒ£ Global Error Boundary (root level)

Táº¡o `app/error.tsx` nhÆ° fallback toÃ n cá»¥c:

```tsx
// app/error.tsx
"use client";

export default function GlobalError({
  error,
  reset,
}: {
  error: Error;
  reset: () => void;
}) {
  console.error("ğŸ”¥ Global Error:", error);
  return (
    <html>
      <body className="p-10 text-center">
        <h1>ğŸ˜¢ Something went wrong</h1>
        <p>{error.message}</p>
        <button onClick={() => reset()}>Reload App</button>
      </body>
    </html>
  );
}
```

> âš ï¸ LÆ°u Ã½: `GlobalError` pháº£i return cáº£ `<html>` & `<body>` (vÃ¬ nÃ³ render toÃ n app).

---

## ğŸ§© 7ï¸âƒ£ Error vs. Not Found vs. Redirect

| TrÆ°á»ng há»£p          | DÃ¹ng gÃ¬                           | VÃ­ dá»¥                    |
| ------------------- | --------------------------------- | ------------------------ |
| Dá»¯ liá»‡u khÃ´ng cÃ³    | `notFound()` hoáº·c `not-found.tsx` | `throw notFound()`       |
| Lá»—i logic / runtime | `error.tsx`                       | `throw new Error("...")` |
| KhÃ´ng cÃ³ quyá»n      | Redirect                          | `redirect("/login")`     |
| API lá»—i             | Tráº£ JSON `{ error: "..." }`       |                          |

---

## ğŸ§  8ï¸âƒ£ Pattern chuáº©n (Enterprise UX)

```tsx
try {
  const data = await getData();
  if (!data) notFound();
  return <UI data={data} />;
} catch (err) {
  console.error(err);
  if (err instanceof AuthError) redirect("/login");
  throw err; // fallback sang error.tsx
}
```

> MÃ´ hÃ¬nh nÃ y giÃºp tÃ¡ch rÃµ 3 tÃ¬nh huá»‘ng:
> ğŸ”¹ Dá»¯ liá»‡u rá»—ng â†’ notFound
> ğŸ”¹ KhÃ´ng quyá»n â†’ redirect
> ğŸ”¹ Lá»—i báº¥t ngá» â†’ error.tsx

---

## ğŸš€ Káº¿t luáº­n

| Ká»¹ thuáº­t                              | Má»¥c Ä‘Ã­ch                    | Má»©c Ä‘á»™       |
| ------------------------------------- | --------------------------- | ------------ |
| `error.tsx`                           | Render UI khi component lá»—i | ğŸ”¹ CÆ¡ báº£n    |
| `try/catch` trong server action / API | Báº¯t lá»—i logic               | ğŸ”¸ Trung cáº¥p |
| `notFound()`, `redirect()`            | Xá»­ lÃ½ flow UI há»£p lÃ½        | ğŸ”¸ Trung cáº¥p |
| Logging (Sentry, Datadog)             | Theo dÃµi lá»—i production     | ğŸ”¸ NÃ¢ng cao  |
| Global Error Boundary                 | Fallback toÃ n há»‡ thá»‘ng      | ğŸ”¹ NÃ¢ng cao  |


---
[<< BÃ€I 24](./24.md) | [BÃ€I 26 >>](./26.md)