# Ngày 18

## Promise

**Promise** trong JavaScript là cách xử lý các thao tác bất đồng bộ, cho phép xử lý kết quả thành công hoặc lỗi của một tác vụ. Promise có ba trạng thái:

- **Pending**: Trạng thái ban đầu, chưa hoàn thành hoặc thất bại.
- **Fulfilled**: Tác vụ hoàn thành thành công.
- **Rejected**: Tác vụ thất bại.

Một Promise có thể được giải quyết (resolve) với giá trị hoặc bị từ chối (reject) với lý do lỗi. Các hàm xử lý được gắn vào Promise thông qua phương thức `then()` hoặc `catch()` sẽ được gọi khi trạng thái thay đổi.

## Callbacks

Để hiểu Promise, trước tiên cần hiểu về **callback**. Callback là một hàm được truyền làm tham số để xử lý kết quả hoặc lỗi của một tác vụ bất đồng bộ.

**Ví dụ Callback**:

```js
const doSomething = callback => {
  setTimeout(() => {
    const skills = ['HTML', 'CSS', 'JS']
    callback('It did not go well', skills)
  }, 2000)
}

const callback = (err, result) => {
  if (err) return console.log(err)
  return console.log(result)
}

doSomething(callback) // It did not go well
```

Nếu không có lỗi:

```js
const doSomething = callback => {
  setTimeout(() => {
    const skills = ['HTML', 'CSS', 'JS']
    callback(false, skills)
  }, 2000)
}

doSomething((err, result) => {
  if (err) return console.log(err)
  return console.log(result)
}) // ['HTML', 'CSS', 'JS']
```

### Promise Constructor

Tạo Promise bằng từ khóa `new Promise`, với một hàm callback nhận hai tham số: `resolve` và `reject`.

```js
const doPromise = new Promise((resolve, reject) => {
  setTimeout(() => {
    const skills = ['HTML', 'CSS', 'JS']
    if (skills.length > 0) {
      resolve(skills)
    } else {
      reject('Something wrong has happened')
    }
  }, 2000)
})

doPromise
  .then(result => console.log(result))
  .catch(error => console.error(error))
// ['HTML', 'CSS', 'JS']
```

**Promise bị reject**:

```js
const doPromise = new Promise((resolve, reject) => {
  setTimeout(() => {
    const skills = ['HTML', 'CSS', 'JS']
    if (skills.includes('Node')) {
      resolve('fullstack developer')
    } else {
      reject('Something wrong has happened')
    }
  }, 2000)
})

doPromise
  .then(result => console.log(result))
  .catch(error => console.error(error))
// Something wrong has happened
```

## Fetch API

**Fetch API** cung cấp giao diện để lấy tài nguyên (bao gồm qua mạng). Nó mạnh mẽ và linh hoạt hơn so với `XMLHttpRequest`.

**Ví dụ sử dụng Fetch với Promise**:

```js
const url = 'https://restcountries.com/v2/all'
fetch(url)
  .then(response => response.json())
  .then(data => console.log(data))
  .catch(error => console.error(error))
```

## Async và Await

**Async/Await** là cách thanh lịch để xử lý Promise, dễ đọc và viết.

```js
const square = async function (n) {
  return n * n
}
square(2).then(result => console.log(result)) // 4
```

Sử dụng `await` để lấy giá trị từ Promise:

```js
const square = async function (n) {
  return n * n
}
const getValue = async () => {
  const value = await square(2)
  console.log(value)
}
getValue() // 4
```

**Sử dụng Fetch với Async/Await**:

```js
const fetchData = async () => {
  try {
    const response = await fetch('https://restcountries.com/v2/all')
    const countries = await response.json()
    console.log(countries)
  } catch (err) {
    console.error(err)
  }
}
fetchData()
```

---

## Bài tập: Ngày 18

### Bài tập: Cấp độ 1

1. **Đọc API countries và in tên quốc gia, thủ đô, ngôn ngữ, dân số, diện tích**

```js
const countriesAPI = 'https://restcountries.com/v2/all'
const fetchCountries = async () => {
  try {
    const response = await fetch(countriesAPI)
    const countries = await response.json()
    countries.forEach(({ name, capital, languages, population, area }) => {
      console.log(`Country: ${name}`)
      console.log(`Capital: ${capital || 'N/A'}`)
      console.log(`Languages: ${languages.map(lang => lang.name).join(', ')}`)
      console.log(`Population: ${population}`)
      console.log(`Area: ${area || 'N/A'} km²`)
      console.log('---')
    })
  } catch (err) {
    console.error(err)
  }
}
fetchCountries()
```

### Bài tập: Cấp độ 2

1. **In tất cả tên mèo vào biến catNames**

```js
const catsAPI = 'https://api.thecatapi.com/v1/breeds'
const fetchCatNames = async () => {
  try {
    const response = await fetch(catsAPI)
    const cats = await response.json()
    const catNames = cats.map(cat => cat.name)
    console.log(catNames)
    return catNames
  } catch (err) {
    console.error(err)
  }
}
fetchCatNames()
```

### Bài tập: Cấp độ 3

1. **Tìm trọng lượng trung bình của mèo (đơn vị metric)**

```js
const fetchAverageCatWeight = async () => {
  try {
    const response = await fetch(catsAPI)
    const cats = await response.json()
    const weights = cats.map(cat => {
      const [min, max] = cat.weight.metric.split(' - ').map(Number)
      return (min + max) / 2
    })
    const averageWeight = weights.reduce((sum, weight) => sum + weight, 0) / weights.length
    console.log(`Average cat weight: ${averageWeight.toFixed(2)} kg`)
  } catch (err) {
    console.error(err)
  }
}
fetchAverageCatWeight()
```

2. **Tìm 10 quốc gia lớn nhất theo diện tích**

```js
const fetchLargestCountries = async () => {
  try {
    const response = await fetch(countriesAPI)
    const countries = await response.json()
    const largestCountries = countries
      .sort((a, b) => (b.area || 0) - (a.area || 0))
      .slice(0, 10)
      .map(({ name, area }) => ({ name, area }))
    console.log(largestCountries)
  } catch (err) {
    console.error(err)
  }
}
fetchLargestCountries()
```
hoặc dùng `flatMap` :

```js
const countLanguages = async () => {
  try {
    const response = await fetch(countriesAPI);
    const countries = await response.json();
    
    const languages = new Set(countries.flatMap(country => 
      country.languages?.map(lang => lang.name) || []
    ));
    
    console.log(`Total official languages: ${languages.size}`);
  } catch (err) {
    console.error(err);
  }
};

countLanguages();


```


3. **Đếm tổng số ngôn ngữ chính thức trên thế giới**

```js
const countLanguages = async () => {
  try {
    const response = await fetch(countriesAPI)
    const countries = await response.json()
    const languages = new Set()
    countries.forEach(country => {
      if (country.languages) {
        country.languages.forEach(lang => languages.add(lang.name))
      }
    })
    console.log(`Total official languages: ${languages.size}`)
  } catch (err) {
    console.error(err)
  }
}
countLanguages()
```

---

[<< Ngày 17](./17.Web_Storages.md) | [Ngày 19 >>](./19.Closures.md)