# Lưu trữ dữ liệu
<details>
<summary><strong>1. Tìm hiểu JavaScript IndexedDB</strong></summary>

### 1. IndexedDB là gì?

* **IndexedDB** là một **API cấp thấp** dùng để lưu trữ dữ liệu **phía client (trình duyệt)**.
* Có thể lưu **dữ liệu có cấu trúc phức tạp**, bao gồm **file**, **blob**, **object**.
* Lưu trữ dữ liệu theo **key-value**, key có thể là thuộc tính của object, value có thể là object phức tạp.
* Là **cơ sở dữ liệu NoSQL**, không phải cơ sở dữ liệu quan hệ (không có bảng, dòng, cột).

---

### 2. Tại sao nên dùng IndexedDB?

| Điểm nổi bật | IndexedDB                         | LocalStorage   |
| ------------ | --------------------------------- | -------------- |
| Dung lượng   | \~50MB (có thể tăng khi yêu cầu)  | \~5MB          |
| Bất đồng bộ  | ✔ (asynchronous)                  | ❌ (đồng bộ)    |
| Web Worker   | Hỗ trợ                            | Không hỗ trợ   |
| Tìm kiếm     | Dựa trên **index** giúp tìm nhanh | Không có index |

**Ưu điểm:**

* **Bất đồng bộ**, tránh block DOM → trình duyệt mượt hơn.
* **Dung lượng lớn**, có thể lưu trữ dữ liệu nhiều hơn LocalStorage.
* **Index** giúp tìm kiếm nhanh.

---

### 3. Khái niệm cơ bản trong IndexedDB

#### Database

* Là **kho chứa thông tin**, gồm 1 hoặc nhiều **object store**.
* **Tên (name)**: xác định database trên mỗi origin.
* **Version**: phiên bản hiện tại của database, mặc định là `1`.

  * Khi nâng cấp database, tăng `version` → event `upgradeneeded` được gọi.

#### Object Store

* Nơi lưu trữ **các bản ghi** (records) dưới dạng **key-value**.
* Mỗi database có thể có nhiều object store.
* Tên của object store phải **khác nhau** trong cùng database.

#### Transaction

* Mọi thao tác (đọc, ghi, sửa, xóa) **phải diễn ra trong transaction**.
* Transaction gồm:

  * **Data-access**: truy cập dữ liệu
  * **Data-modification**: chỉnh sửa dữ liệu
* Transaction có 2 chế độ:

  * `readonly`
  * `readwrite`

#### Request

* Là tiến trình thực hiện **đọc/ghi dữ liệu**.
* Có sự kiện `onsuccess` và `onerror` để biết tiến trình thành công hay thất bại.

#### Index

* Dùng để **tìm kiếm nhanh** các bản ghi trong object store.
* Có thể tạo nhiều index cho cùng một object store.

#### Key Path

* Xác định **thuộc tính nào của object** được dùng làm key.
* Hợp lệ: string, mảng string, các định danh JS, không có khoảng trắng.

---

### 4. Kiểm tra trình duyệt hỗ trợ IndexedDB

```js
window.indexedDB =
  window.indexedDB ||
  window.mozIndexedDB ||
  window.webkitIndexedDB ||
  window.msIndexedDB;

window.IDBTransaction =
  window.IDBTransaction ||
  window.webkitIDBTransaction ||
  window.msIDBTransaction;

window.IDBKeyRange =
  window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

if (!window.indexedDB) {
  window.alert("Your browser doesn't support a stable version of IndexedDB.");
}
```

---

### 5. Mở (Open) Database

```js
// Mở database version mặc định
var request = indexedDB.open("MyDatabase");

// Mở database với version cụ thể
var request = indexedDB.open("MyDatabase", 2);

request.onsuccess = function(event) {
  console.log("Database opened successfully");
};

request.onerror = function(event) {
  console.log("Error opening database", event);
};

request.onupgradeneeded = function(event) {
  var db = event.target.result;
  // Tạo object store khi nâng cấp version
  var store = db.createObjectStore("Users", { keyPath: "id" });
};
```

---

### 6. Thêm một bản ghi vào Object Store

```js
function addUser(db, user) {
  var transaction = db.transaction(["Users"], "readwrite");
  var store = transaction.objectStore("Users");
  var request = store.add(user);

  request.onsuccess = function() {
    console.log("User added successfully");
  };

  request.onerror = function(event) {
    console.log("Add user error", event);
  };
}

// Ví dụ user:
addUser(db, { id: 1, name: "John", email: "john@example.com" });
```

---

### 7. Lấy một bản ghi theo key

```js
function getUser(db, id) {
  var transaction = db.transaction(["Users"], "readonly");
  var store = transaction.objectStore("Users");
  var request = store.get(id);

  request.onsuccess = function(event) {
    console.log("User found:", request.result);
  };

  request.onerror = function(event) {
    console.log("Get user error", event);
  };
}

getUser(db, 1);
```

---

### 8. Xóa một bản ghi theo key

```js
function deleteUser(db, id) {
  var transaction = db.transaction(["Users"], "readwrite");
  var store = transaction.objectStore("Users");
  var request = store.delete(id);

  request.onsuccess = function(event) {
    console.log("User deleted successfully");
  };

  request.onerror = function(event) {
    console.log("Delete user error", event);
  };
}

deleteUser(db, 1);
```

---

### 9. Quét toàn bộ dữ liệu Object Store

```js
function readAllUsers(db) {
  var transaction = db.transaction(["Users"], "readonly");
  var store = transaction.objectStore("Users");

  store.openCursor().onsuccess = function(event) {
    var cursor = event.target.result;
    if (cursor) {
      console.log(cursor.key, cursor.value);
      cursor.continue();
    } else {
      console.log("No more entries!");
    }
  };
}

readAllUsers(db);
```

---

### 10. Kết luận

* IndexedDB **lưu trữ dữ liệu phức tạp**, dung lượng lớn và bất đồng bộ.
* Cần hiểu các **khái niệm**: Database, Object Store, Transaction, Request, Index, Key Path.
* Sử dụng IndexedDB giúp **tăng hiệu năng**, tránh block DOM so với LocalStorage.
* Có thể áp dụng **Promise hoặc async/await** để viết code dễ đọc hơn.

**Tham khảo:**

* [MDN IndexedDB](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)
* [Using IndexedDB](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB)
* [IndexedDB concepts](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Basic_concepts)

</details>
<details>
<summary><strong>2. LocalForage – Thay thế IndexedDB</strong></summary>

### 1. LocalForage là gì?

* **LocalForage** là một **thư viện JavaScript mã nguồn mở**, giúp tương tác với **database trên trình duyệt** trở nên dễ dàng hơn.
* Nó **giúp sử dụng IndexedDB đơn giản hơn**, hỗ trợ **Promise**, API gần giống `localStorage`.
* Nếu trình duyệt **không hỗ trợ IndexedDB**, localForage sẽ tự động dùng **WebSQL** hoặc **localStorage**.

**Ưu điểm:**

* Giao diện API giống `localStorage`: `setItem()`, `getItem()`, `removeItem()`, `clear()`.
* Hỗ trợ **ES6 Promise**.
* Hỗ trợ **IndexedDB, WebSQL, localStorage**.
* Hỗ trợ nhiều trình duyệt: Chrome, Firefox, IE, Safari, Safari Mobile.

---

### 2. Cài đặt LocalForage

**Sử dụng CDN:**

```html
<script src="https://unpkg.com/localforage@1.7.3/dist/localforage.min.js"></script>
<script>
  console.log("localforage is: ", localforage);
</script>
```

**Sử dụng npm:**

```bash
npm install localforage
```

**Sử dụng với bundler (Webpack, Vite, ...):**

```js
import localforage from "localforage";

localforage.setItem("key", "value");
```

---

### 3. Sử dụng API cơ bản

#### setItem()

Lưu dữ liệu key-value.

```js
// Promise
localforage.setItem("my point", { x: 1, y: 2 })
  .then(value => console.log(value))
  .catch(err => console.log(err));
```

* `key`: string, phân biệt hoa-thường.
* `value`: bất kỳ kiểu dữ liệu nào (number, string, array, object, file/blob).
* Nếu key tồn tại, giá trị **bị ghi đè**.

---

#### getItem()

Lấy dữ liệu từ key.

```js
localforage.getItem("my point")
  .then(value => console.log(value.x, value.y))
  .catch(err => console.log(err));
```

* Nếu key không tồn tại → giá trị trả về là `null`.

---

#### removeItem()

Xóa key-value theo key.

```js
localforage.removeItem("my point")
  .then(() => console.log("Key is cleared!"))
  .catch(err => console.log(err));
```

* Nếu key không tồn tại → vẫn được coi là thành công.

---

#### clear()

Xóa toàn bộ dữ liệu trong database.

```js
localforage.clear()
  .then(() => console.log("Database is now empty."))
  .catch(err => console.log(err));
```

* Hành động này **xóa toàn bộ dữ liệu**, nên cần thận trọng.

---

### 4. Một số API khác

* `length(callback)`: số lượng key-value.
* `keys(callback)`: mảng các key.
* `iterate(iteratorCallback, callback)`: duyệt tất cả cặp key-value.
* `key(index, callback)`: trả về key theo index.

---

### 5. Cấu hình LocalForage

#### setDriver()

Chọn **storage type** ưu tiên.

```js
localforage.setDriver(localforage.LOCALSTORAGE);
// hoặc ưu tiên WebSQL rồi IndexedDB
localforage.setDriver([localforage.WEBSQL, localforage.INDEXEDDB]);
```

#### config()

Cấu hình các thông tin cơ bản.

```js
localforage.config({
  driver: localforage.INDEXEDDB,
  name: "MyApp",
  storeName: "myStore",
  description: "App database"
});
```

* Khác với hầu hết API localForage → `config()` **đồng bộ**.

---

### 6. Sử dụng nhiều database (instances)

```js
let twoDStore = localforage.createInstance({ name: "2-D" });
let threeDStore = localforage.createInstance({ name: "3-D" });

twoDStore.setItem("a", { x: 1, y: 2 });
threeDStore.setItem("a", { x: 1, y: 2, z: 3 });

twoDStore.getItem("a").then(v => console.log(v)); // {x:1, y:2}
threeDStore.getItem("a").then(v => console.log(v)); // {x:1, y:2, z:3}
```

* Các instance **không liên quan** với nhau, kể cả key giống nhau.

---

### 7. Lời kết

* LocalForage là **công cụ tuyệt vời** để quản lý database phía client.
* Giúp **simplify IndexedDB**, hỗ trợ Promise và API giống `localStorage`.
* Có thể cấu hình driver, database, hoặc tạo nhiều instance cho từng mục đích khác nhau.

**Tham khảo:**

* [Trang chủ localForage](https://localforage.github.io/localForage/)
* [GitHub localForage](https://github.com/localForage/localForage)

</details>
<details>
<summary><strong>3. Tìm hiểu về HTTP Cookie trong JavaScript</strong></summary>

### 1. HTTP Cookie là gì?

* **HTTP Cookie** (còn gọi là web cookie, browser cookie) là dữ liệu mà **server gửi về trình duyệt**, và trình duyệt sẽ **lưu trữ** và gửi lại cookie này cho server trong mỗi request tiếp theo.
* Mục đích: **giữ trạng thái** giữa các request, vì HTTP là **stateless**.
  Ví dụ: giữ trạng thái đăng nhập, giỏ hàng, ngôn ngữ, theme,...

---

### 2. Tác dụng chính của cookie

1. **Quản lý session:** trạng thái đăng nhập, giỏ hàng.
2. **Lưu thông tin cài đặt người dùng:** theme, ngôn ngữ, username/email.
3. **Theo dõi và phân tích hành vi người dùng:** các trang đã truy cập, số lần truy cập.

---

### 3. Giới hạn của cookie

* Dung lượng **giới hạn \~4KB**.
* Cookie **chỉ private với domain** của nó.
* Nếu vượt quá giới hạn → cookie mới ghi đè cookie cũ.
* Người dùng có thể **tắt cookie** → không sử dụng được.
* **Không bảo mật**, có thể bị đánh cắp nếu không dùng các biện pháp bảo vệ.

---

### 4. Thao tác với cookie bằng JavaScript

#### a) Tạo mới một cookie

```js
document.cookie = "foo1=bar1";
document.cookie = "foo2=bar2";
```

* Cookie được **tạo thêm**, không ghi đè cookie hiện có.
* Giá trị nên encode:

```js
const value = encodeURIComponent("Lam Pham");
document.cookie = `name=${value}`;
```

#### b) Cài đặt thời điểm hết hạn

* Sử dụng **expires**:

```js
document.cookie = "foo1=bar1; expires=Thu, 04 Apr 2019 17:00:00 GMT";
```

* Hoặc dùng `toUTCString()` để format thời gian:

```js
const d = new Date(2019, 03, 5).toUTCString();
console.log(d); // Thu, 04 Apr 2019 17:00:00 GMT
```

#### c) Cài đặt thời gian sống (max-age)

```js
document.cookie = "foo1=bar1; max-age=3600"; // hết hạn sau 1h
document.cookie = "foo2=bar2; max-age=31536000"; // hết hạn sau 1 năm
```

#### d) Cài đặt domain

```js
document.cookie = 'foo1=bar1; domain="sub1.domain.com";';
```

* Giới hạn cookie chỉ tồn tại trong domain cụ thể và các subdomain của nó.

#### e) Cài đặt path

```js
document.cookie = 'foo=bar; path="/category"';
```

* Cookie sẽ tồn tại trong path `/category` và các path con, không có ở các path khác.

> Có thể kết hợp các thuộc tính:

```js
document.cookie = 'foo1=bar1; expires=Thu, 04 Apr 2019 17:00:00 GMT; domain="mysite.com"; path="/category"';
```

#### f) Cập nhật cookie

* Ghi đè cookie với cùng key:

```js
document.cookie = "foo=bar2; max-age=3600";
```

#### g) Đọc cookie

```js
const cookies = document.cookie;
console.log(cookies); // "foo1=bar1; foo2=bar2"
```

* `document.cookie` trả về **chuỗi** tất cả cookie, các cặp `key=value` phân cách bằng `; `.

#### h) Xóa cookie

```js
document.cookie = "foo=; expires=Wed, 27 Feb 2019 07:41:28 GMT;";
```

---

### 5. Cookie từ phía server

* Server gửi cookie qua **header Set-Cookie**:

```http
HTTP/2.0 200 OK
Content-type: text/html
Set-Cookie: foo1=bar1
Set-Cookie: foo2=bar2
```

* Client gửi lại cookie qua **header Cookie**:

```http
GET /sample.html HTTP/2.0
Host: www.example.org
Cookie: foo1=bar1; foo2=bar2
```

**Thuộc tính bảo mật quan trọng:**

* **Secure:** chỉ gửi cookie qua HTTPS.
* **HttpOnly:** chỉ server mới truy cập, client không thể thao tác bằng `document.cookie`.
* **SameSite:** ngăn cookie gửi qua cross-site request.

---

### 6. Kiểm tra cookie trên trình duyệt

* Console:

```js
document.cookie; // => "foo1=bar1; foo2=bar2"
```

* DevTools → Application → Storage → Cookies.

---

### 7. Lời kết

* HTTP Cookie giúp **quản lý session, lưu trữ cài đặt, theo dõi người dùng**.
* Có thể thao tác **từ client (JS) hoặc server**.
* Cần chú ý **bảo mật và giới hạn dung lượng**.

**Tham khảo:**

* [Learn how HTTP Cookies work](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)
* [HTTP cookies – MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)
* [Document.cookie](https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie)
* [JavaScript Cookies – npm](https://www.npmjs.com/package/js-cookie)
* [cookie-session – npm](https://www.npmjs.com/package/cookie-session)

</details>
