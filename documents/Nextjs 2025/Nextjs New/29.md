# Bài Giảng Chi Tiết: Intercepting Routes trong Next.js App Router

## 1. Giới Thiệu về Intercepting Routes

**Intercepting Routes** cho phép bạn "chặn" một route và hiển thị nội dung khác trong context hiện tại, trong khi vẫn giữ nguyên URL. Đây là một pattern mạnh mẽ để tạo các trải nghiệm người dùng phức tạp như modals, overlays, và context-aware navigation.

### Khái niệm cốt lõi

Khi người dùng click vào một link, thay vì navigate đến page mới hoàn toàn, bạn có thể "intercept" navigation đó và hiển thị nội dung trong modal/overlay, nhưng URL vẫn thay đổi. Khi refresh page, sẽ hiển thị full page bình thường.

### Tại sao cần Intercepting Routes?

- **Modal với Deep Links**: Mở ảnh trong modal nhưng vẫn có URL riêng để share
- **Multi-step Flows**: Wizards và forms phức tạp
- **Context Preservation**: Giữ nguyên context của page hiện tại
- **Better UX**: Faster navigation, smooth transitions

## 2. Cú Pháp Convention

Intercepting Routes sử dụng convention `(..)` để chỉ định level cần intercept:

| Convention | Mô tả | Tương đương |
|------------|-------|-------------|
| `(.)` | Match segments ở **cùng level** | `./` |
| `(..)` | Match segments ở **level trên một cấp** | `../` |
| `(..)(..)` | Match segments ở **level trên hai cấp** | `../../` |
| `(...)` | Match segments từ **root app** | `/` |

### Lưu ý quan trọng
Convention `(..)` dựa trên **route segments**, không phải folder structure trong file system!

## 3. Cấu Trúc Cơ Bản

### 3.1. Ví dụ đơn giản

```
app/
├── feed/
│   ├── (..)photo/
│   │   └── [id]/
│   │       └── page.tsx    // Modal view
│   └── page.tsx            // Feed page
├── photo/
│   └── [id]/
│       └── page.tsx        // Full page view
└── layout.tsx
```

**Cách hoạt động:**
- Từ `/feed`, click link đến `/photo/123` → Hiển thị modal (intercepted)
- Direct navigation hoặc refresh `/photo/123` → Hiển thị full page
- URL luôn là `/photo/123` trong cả hai trường hợp

### 3.2. Code Implementation

```tsx
// app/photo/[id]/page.tsx - Full page view
export default function PhotoPage({ params }: { params: { id: string } }) {
  return (
    <div className="full-page">
      <h1>Photo {params.id}</h1>
      <img src={`/api/photos/${params.id}`} alt="Photo" />
      <div className="photo-details">
        {/* Full photo details */}
      </div>
    </div>
  );
}

// app/feed/(..)photo/[id]/page.tsx - Modal view
export default function PhotoModal({ params }: { params: { id: string } }) {
  return (
    <div className="modal-overlay">
      <div className="modal-content">
        <img src={`/api/photos/${params.id}`} alt="Photo" />
        <button>Close</button>
      </div>
    </div>
  );
}

// app/feed/page.tsx
import Link from 'next/link';

export default function Feed() {
  const photos = [1, 2, 3, 4, 5];
  
  return (
    <div className="feed">
      <h1>Photo Feed</h1>
      <div className="grid">
        {photos.map((id) => (
          <Link key={id} href={`/photo/${id}`}>
            <img src={`/api/photos/${id}/thumb`} alt={`Photo ${id}`} />
          </Link>
        ))}
      </div>
    </div>
  );
}
```

## 4. Kết Hợp với Parallel Routes

Intercepting Routes thường được kết hợp với Parallel Routes để tạo modal experiences tốt hơn.

### 4.1. Cấu trúc Modal Pattern

```
app/
├── @modal/
│   ├── (..)photo/
│   │   └── [id]/
│   │       └── page.tsx
│   └── default.tsx
├── photo/
│   └── [id]/
│       └── page.tsx
├── layout.tsx
└── page.tsx
```

### 4.2. Implementation chi tiết

```tsx
// app/layout.tsx
export default function RootLayout({
  children,
  modal,
}: {
  children: React.ReactNode;
  modal: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        {children}
        {modal}
      </body>
    </html>
  );
}

// app/@modal/default.tsx
export default function Default() {
  return null;
}

// app/@modal/(..)photo/[id]/page.tsx
import { Modal } from '@/components/Modal';

export default function PhotoModal({ params }: { params: { id: string } }) {
  return (
    <Modal>
      <img 
        src={`/api/photos/${params.id}`} 
        alt="Photo" 
        className="max-w-full"
      />
    </Modal>
  );
}

// app/photo/[id]/page.tsx
export default function PhotoPage({ params }: { params: { id: string } }) {
  return (
    <div>
      <h1>Photo {params.id}</h1>
      <img src={`/api/photos/${params.id}`} alt="Photo" />
    </div>
  );
}
```

## 5. Modal Component với Close Handler

### 5.1. Client Component Modal

```tsx
// components/Modal.tsx
'use client';

import { useRouter } from 'next/navigation';
import { useCallback, useRef, useEffect } from 'react';

export function Modal({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  const overlayRef = useRef<HTMLDivElement>(null);
  const wrapperRef = useRef<HTMLDivElement>(null);

  const onDismiss = useCallback(() => {
    router.back();
  }, [router]);

  const onClick = useCallback(
    (e: React.MouseEvent) => {
      if (e.target === overlayRef.current) {
        onDismiss();
      }
    },
    [onDismiss]
  );

  const onKeyDown = useCallback(
    (e: KeyboardEvent) => {
      if (e.key === 'Escape') onDismiss();
    },
    [onDismiss]
  );

  useEffect(() => {
    document.addEventListener('keydown', onKeyDown);
    return () => document.removeEventListener('keydown', onKeyDown);
  }, [onKeyDown]);

  return (
    <div
      ref={overlayRef}
      className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
      onClick={onClick}
    >
      <div
        ref={wrapperRef}
        className="bg-white rounded-lg p-6 max-w-2xl max-h-[90vh] overflow-auto"
      >
        <button
          onClick={onDismiss}
          className="absolute top-4 right-4 text-white text-2xl"
        >
          ×
        </button>
        {children}
      </div>
    </div>
  );
}
```

## 6. Các Convention Levels Chi Tiết

### 6.1. Same Level - `(.)`

```
app/
├── shop/
│   ├── (.)product/
│   │   └── [id]/
│   │       └── page.tsx    // Intercepts /shop/product/[id]
│   ├── product/
│   │   └── [id]/
│   │       └── page.tsx    // Original route
│   └── page.tsx
```

### 6.2. One Level Up - `(..)`

```
app/
├── feed/
│   ├── (..)photo/
│   │   └── [id]/
│   │       └── page.tsx    // Intercepts /photo/[id] from /feed
│   └── page.tsx
├── photo/
│   └── [id]/
│       └── page.tsx        // Original route
```

### 6.3. Two Levels Up - `(..)(..)`

```
app/
├── blog/
│   └── posts/
│       ├── (..)(..)/photo/
│       │   └── [id]/
│       │       └── page.tsx    // Intercepts /photo/[id] from /blog/posts
│       └── page.tsx
├── photo/
│   └── [id]/
│       └── page.tsx
```

### 6.4. Root Level - `(...)`

```
app/
├── dashboard/
│   └── settings/
│       ├── (...)/photo/
│       │   └── [id]/
│       │       └── page.tsx    // Intercepts /photo/[id] from anywhere
│       └── page.tsx
├── photo/
│   └── [id]/
│       └── page.tsx
```

## 7. Use Cases Thực Tế

### 7.1. Photo Gallery như Instagram

```
app/
├── @modal/
│   ├── (..)p/
│   │   └── [id]/
│   │       └── page.tsx
│   └── default.tsx
├── p/
│   └── [id]/
│       └── page.tsx
├── page.tsx                    // Home feed
└── layout.tsx
```

```tsx
// app/page.tsx - Home Feed
import Link from 'next/link';

async function getPhotos() {
  const res = await fetch('https://api.example.com/photos');
  return res.json();
}

export default async function Home() {
  const photos = await getPhotos();
  
  return (
    <div className="grid grid-cols-3 gap-4">
      {photos.map((photo: any) => (
        <Link key={photo.id} href={`/p/${photo.id}`}>
          <img 
            src={photo.thumbnail} 
            alt={photo.title}
            className="aspect-square object-cover"
          />
        </Link>
      ))}
    </div>
  );
}

// app/@modal/(..)p/[id]/page.tsx - Modal View
import { Modal } from '@/components/Modal';

async function getPhoto(id: string) {
  const res = await fetch(`https://api.example.com/photos/${id}`);
  return res.json();
}

export default async function PhotoModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  const photo = await getPhoto(params.id);
  
  return (
    <Modal>
      <div className="space-y-4">
        <img src={photo.url} alt={photo.title} />
        <div>
          <h2 className="text-2xl font-bold">{photo.title}</h2>
          <p className="text-gray-600">{photo.description}</p>
        </div>
        <div className="flex items-center gap-4">
          <button>❤️ Like</button>
          <button>💬 Comment</button>
          <button>🔗 Share</button>
        </div>
      </div>
    </Modal>
  );
}

// app/p/[id]/page.tsx - Full Page View
async function getPhoto(id: string) {
  const res = await fetch(`https://api.example.com/photos/${id}`);
  return res.json();
}

export default async function PhotoPage({ 
  params 
}: { 
  params: { id: string } 
}) {
  const photo = await getPhoto(params.id);
  
  return (
    <div className="max-w-4xl mx-auto py-8">
      <img src={photo.url} alt={photo.title} className="w-full" />
      <div className="mt-8">
        <h1 className="text-4xl font-bold">{photo.title}</h1>
        <p className="mt-4 text-lg">{photo.description}</p>
        <div className="mt-8">
          <h2>Comments</h2>
          {/* Comments section */}
        </div>
      </div>
    </div>
  );
}
```

### 7.2. E-commerce Quick View

```
app/
├── @modal/
│   ├── (..)product/
│   │   └── [id]/
│   │       └── page.tsx
│   └── default.tsx
├── products/
│   └── page.tsx
├── product/
│   └── [id]/
│       └── page.tsx
└── layout.tsx
```

```tsx
// app/products/page.tsx
import Link from 'next/link';

export default function ProductsPage() {
  const products = [
    { id: 1, name: 'Product 1', price: 99 },
    { id: 2, name: 'Product 2', price: 149 },
  ];
  
  return (
    <div className="grid grid-cols-4 gap-6">
      {products.map((product) => (
        <div key={product.id} className="border rounded-lg p-4">
          <Link href={`/product/${product.id}`}>
            <img src={`/products/${product.id}.jpg`} alt={product.name} />
            <h3>{product.name}</h3>
            <p>${product.price}</p>
          </Link>
        </div>
      ))}
    </div>
  );
}

// app/@modal/(..)product/[id]/page.tsx - Quick View Modal
import { Modal } from '@/components/Modal';

export default async function ProductQuickView({ 
  params 
}: { 
  params: { id: string } 
}) {
  const product = await getProduct(params.id);
  
  return (
    <Modal>
      <div className="grid grid-cols-2 gap-6">
        <img src={product.image} alt={product.name} />
        <div>
          <h2 className="text-2xl font-bold">{product.name}</h2>
          <p className="text-xl font-bold mt-2">${product.price}</p>
          <p className="mt-4">{product.description}</p>
          <button className="mt-6 bg-blue-600 text-white px-6 py-2 rounded">
            Add to Cart
          </button>
          <Link 
            href={`/product/${product.id}`}
            className="block mt-4 text-blue-600"
          >
            View Full Details
          </Link>
        </div>
      </div>
    </Modal>
  );
}

// app/product/[id]/page.tsx - Full Product Page
export default async function ProductPage({ 
  params 
}: { 
  params: { id: string } 
}) {
  const product = await getProduct(params.id);
  
  return (
    <div className="max-w-6xl mx-auto py-8">
      <div className="grid grid-cols-2 gap-12">
        <div>
          <img src={product.image} alt={product.name} className="w-full" />
          {/* More images */}
        </div>
        <div>
          <h1 className="text-4xl font-bold">{product.name}</h1>
          <p className="text-2xl font-bold mt-4">${product.price}</p>
          <p className="mt-6">{product.fullDescription}</p>
          {/* Specifications, reviews, etc. */}
        </div>
      </div>
    </div>
  );
}
```

### 7.3. Login/Signup Modal

```
app/
├── @auth/
│   ├── (..)login/
│   │   └── page.tsx
│   ├── (..)signup/
│   │   └── page.tsx
│   └── default.tsx
├── login/
│   └── page.tsx
├── signup/
│   └── page.tsx
├── page.tsx
└── layout.tsx
```

```tsx
// app/layout.tsx
export default function RootLayout({
  children,
  auth,
}: {
  children: React.ReactNode;
  auth: React.ReactNode;
}) {
  return (
    <html>
      <body>
        <nav>
          <Link href="/login">Login</Link>
          <Link href="/signup">Sign Up</Link>
        </nav>
        {children}
        {auth}
      </body>
    </html>
  );
}

// app/@auth/(..)login/page.tsx - Login Modal
import { Modal } from '@/components/Modal';
import { LoginForm } from '@/components/LoginForm';

export default function LoginModal() {
  return (
    <Modal>
      <h2 className="text-2xl font-bold mb-4">Login</h2>
      <LoginForm />
      <p className="mt-4">
        Don't have an account?{' '}
        <Link href="/signup" className="text-blue-600">
          Sign up
        </Link>
      </p>
    </Modal>
  );
}

// app/login/page.tsx - Full Login Page
import { LoginForm } from '@/components/LoginForm';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
        <h1 className="text-3xl font-bold mb-6">Login</h1>
        <LoginForm />
        <p className="mt-6">
          Don't have an account?{' '}
          <Link href="/signup" className="text-blue-600">
            Sign up
          </Link>
        </p>
      </div>
    </div>
  );
}
```

## 8. Advanced Patterns

### 8.1. Nested Intercepting Routes

```
app/
├── dashboard/
│   ├── @modal/
│   │   ├── (..)(..)settings/
│   │   │   └── profile/
│   │   │       └── page.tsx
│   │   └── default.tsx
│   └── page.tsx
├── settings/
│   └── profile/
│       └── page.tsx
```

### 8.2. Conditional Interception

```tsx
// app/@modal/(..)photo/[id]/page.tsx
import { headers } from 'next/headers';
import { Modal } from '@/components/Modal';
import { redirect } from 'next/navigation';

export default async function PhotoModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  const headersList = headers();
  const referer = headersList.get('referer');
  
  // Chỉ intercept nếu đến từ feed
  if (!referer?.includes('/feed')) {
    redirect(`/photo/${params.id}`);
  }
  
  return (
    <Modal>
      {/* Modal content */}
    </Modal>
  );
}
```

### 8.3. Multiple Intercept Points

```
app/
├── feed/
│   ├── (..)photo/
│   │   └── [id]/
│   │       └── page.tsx    // Intercepts from /feed
│   └── page.tsx
├── explore/
│   ├── (..)photo/
│   │   └── [id]/
│   │       └── page.tsx    // Intercepts from /explore
│   └── page.tsx
├── photo/
│   └── [id]/
│       └── page.tsx        // Default full page
```

## 9. Handling Navigation

### 9.1. Programmatic Navigation

```tsx
'use client';

import { useRouter } from 'next/navigation';

export function PhotoCard({ id }: { id: string }) {
  const router = useRouter();
  
  const handleClick = () => {
    // Sẽ trigger intercepting route
    router.push(`/photo/${id}`);
  };
  
  return (
    <div onClick={handleClick}>
      <img src={`/photos/${id}/thumb`} alt="Photo" />
    </div>
  );
}
```

### 9.2. Back Navigation

```tsx
'use client';

import { useRouter } from 'next/navigation';

export function Modal({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  
  return (
    <div className="modal">
      <button onClick={() => router.back()}>Close</button>
      {children}
    </div>
  );
}
```

### 9.3. Replace vs Push

```tsx
'use client';

import { useRouter } from 'next/navigation';

export function GalleryItem({ id }: { id: string }) {
  const router = useRouter();
  
  // Push - adds to history
  const openModal = () => {
    router.push(`/photo/${id}`);
  };
  
  // Replace - doesn't add to history
  const openModalNoHistory = () => {
    router.replace(`/photo/${id}`);
  };
  
  return (
    <div>
      <button onClick={openModal}>Open (with history)</button>
      <button onClick={openModalNoHistory}>Open (no history)</button>
    </div>
  );
}
```

## 10. SEO và Metadata

### 10.1. Generate Metadata cho Intercepted Routes

```tsx
// app/@modal/(..)photo/[id]/page.tsx
import { Metadata } from 'next';

export async function generateMetadata({ 
  params 
}: { 
  params: { id: string } 
}): Promise<Metadata> {
  const photo = await getPhoto(params.id);
  
  return {
    title: photo.title,
    description: photo.description,
    openGraph: {
      images: [photo.url],
    },
  };
}

export default function PhotoModal({ params }: { params: { id: string } }) {
  // Modal content
}
```

### 10.2. Canonical URLs

```tsx
// app/photo/[id]/page.tsx
export async function generateMetadata({ 
  params 
}: { 
  params: { id: string } 
}): Promise<Metadata> {
  return {
    alternates: {
      canonical: `/photo/${params.id}`,
    },
  };
}
```

## 11. Testing Intercepting Routes

### 11.1. Testing Navigation

```tsx
// __tests__/photo-modal.test.tsx
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import PhotoModal from '@/app/@modal/(..)photo/[id]/page';

jest.mock('next/navigation', () => ({
  useRouter: () => ({
    push: jest.fn(),
    back: jest.fn(),
  }),
}));

describe('PhotoModal', () => {
  it('renders photo in modal', async () => {
    render(<PhotoModal params={{ id: '1' }} />);
    
    expect(await screen.findByRole('img')).toBeInTheDocument();
  });
  
  it('closes modal on back button', async () => {
    const mockBack = jest.fn();
    jest.spyOn(require('next/navigation'), 'useRouter')
      .mockImplementation(() => ({ back: mockBack }));
    
    render(<PhotoModal params={{ id: '1' }} />);
    
    await userEvent.click(screen.getByText('Close'));
    expect(mockBack).toHaveBeenCalled();
  });
});
```

## 12. Best Practices

### 12.1. ✅ Do's

```tsx
// ✅ Always provide default.tsx for parallel routes
// app/@modal/default.tsx
export default function Default() {
  return null;
}

// ✅ Handle both intercepted and direct navigation
// app/@modal/(..)photo/[id]/page.tsx - Modal
// app/photo/[id]/page.tsx - Full page

// ✅ Use proper close handlers
function Modal({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  
  return (
    <div onClick={(e) => {
      if (e.target === e.currentTarget) router.back();
    }}>
      {children}
    </div>
  );
}

// ✅ Implement keyboard navigation
useEffect(() => {
  const handleEscape = (e: KeyboardEvent) => {
    if (e.key === 'Escape') router.back();
  };
  
  document.addEventListener('keydown', handleEscape);
  return () => document.removeEventListener('keydown', handleEscape);
}, []);
```

### 12.2. ❌ Don'ts

```tsx
// ❌ Don't use hard-coded navigation levels without considering structure
// Bad: (..)(..)photo when structure might change

// ❌ Don't forget full page implementation
// Always have both modal and full page versions

// ❌ Don't intercept everything
// Only intercept when it improves UX

// ❌ Don't break back button behavior
// Always use router.back() for closing
```

### 12.3. Performance Tips

```tsx
// ✅ Use dynamic imports for heavy modals
import dynamic from 'next/dynamic';

const HeavyModal = dynamic(() => import('@/components/HeavyModal'), {
  loading: () => <div>Loading...</div>,
});

// ✅ Prefetch modal content
<Link href="/photo/1" prefetch={true}>
  View Photo
</Link>

// ✅ Optimize images in modals
import Image from 'next/image';

<Image
  src={photo.url}
  alt={photo.title}
  width={800}
  height={600}
  priority // For above-the-fold modal content
/>
```

## 13. Debugging Tips

### 13.1. Common Issues

```tsx
// Issue: Modal không hiển thị
// Solution: Check default.tsx exists
// app/@modal/default.tsx
export default function Default() {
  return null;
}

// Issue: Full page shows instead of modal
// Solution: Verify route segment matching
// Convention (..) counts route segments, not folders

// Issue: Can't close modal
// Solution: Implement proper back navigation
const router = useRouter();
<button onClick={() => router.back()}>Close</button>
```

### 13.2. Debug Logging

```tsx
// app/@modal/(..)photo/[id]/page.tsx
export default function PhotoModal({ params }: { params: { id: string } }) {
  console.log('PhotoModal rendered for:', params.id);
  console.log('Route intercepted');
  
  return <Modal>{/* content */}</Modal>;
}

// app/photo/[id]/page.tsx
export default function PhotoPage({ params }: { params: { id: string } }) {
  console.log('PhotoPage rendered for:', params.id);
  console.log('Full page route');
  
  return <div>{/* content */}</div>;
}
```

## 14. So Sánh với Các Phương Pháp Khác

| Feature | Intercepting Routes | Client Modal | Server Modal | Router Events |
|---------|-------------------|--------------|--------------|---------------|
| Deep Links | ✅ | ❌ | ❌ | ⚠️ |
| SEO Friendly | ✅ | ❌ | ⚠️ | ❌ |
| Server Components | ✅ | ❌ | ✅ | ❌ |
| Browser History | ✅ | ❌ | ❌ | ✅ |
| Shareable URLs | ✅ | ❌ | ❌ | ⚠️ |
| Refresh Support | ✅ | ❌ | ✅ | ❌ |

## 15. Real-World Example: Full Gallery App

```tsx
// app/layout.tsx
export default function RootLayout({
  children,
  modal,
}: {
  children: React.ReactNode;
  modal: React.ReactNode;
}) {
  return (
    <html>
      <body>
        <nav className="bg-gray-800 text-white p-4">
          <Link href="/">Gallery</Link>
        </nav>
        {children}
        {modal}
      </body>
    </html>
  );
}

// app/page.tsx
import Link from 'next/link';

async function getPhotos() {
  const res = await fetch('https://api.unsplash.com/photos', {
    headers: { Authorization: `Client-ID ${process.env.UNSPLASH_ACCESS_KEY}` },
    next: { revalidate: 3600 }
  });
  return res.json();
}

export default async function HomePage() {
  const photos = await getPhotos();
  
  return (
    <main className="container mx-auto p-4">
      <h1 className="text-3xl font-bold mb-8">Photo Gallery</h1>
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {photos.map((photo: any) => (
          <Link 
            key={photo.id} 
            href={`/photos/${photo.id}`}
            className="group relative aspect-square overflow-hidden rounded-lg"
          >
            <img
              src={photo.urls.small}
              alt={photo.description || 'Photo'}
              className="object-cover w-full h-full group-hover:scale-110 transition"
            />
          </Link>
        ))}
      </div>
    </main>
  );
}

// app/@modal/(..)photos/[id]/page.tsx
import { Modal } from '@/components/Modal';

async function getPhoto(id: string) {
  const res = await fetch(`https://api.unsplash.com/photos/${id}`, {
    headers: { Authorization: `Client-ID ${process.env.UNSPLASH_ACCESS_KEY}` },
  });
  return res.json();
}

export default async function PhotoModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  const photo = await getPhoto(params.id);
  
  return (
    <Modal>
      <div className="max-w-4xl mx-auto">
        <img
          src={photo.urls.regular}
          alt={photo.description || 'Photo'}
          className="w-full rounded-lg"
        />
        <div className="mt-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <img
              src={photo.user.profile_image.small}
              alt={photo.user.name}
              className="w-10 h-10 rounded-full"
            />
            <div>
              <p className="font-semibold">{photo.user.name}</p>
              <p className="text-sm text-gray-600">@{photo.user.username}</p>
            </div>
            </div>
          <div className="flex gap-2">
            <button className="px-4 py-2 bg-blue-600 text-white rounded">
              Like
            </button>
            <button className="px-4 py-2 bg-gray-200 rounded">
              Download
            </button>
          </div>
        </div>
        {photo.description && (
          <p className="mt-4 text-gray-700">{photo.description}</p>
        )}
      </div>
    </Modal>
  );
}

// app/photos/[id]/page.tsx - Full Page View
async function getPhoto(id: string) {
  const res = await fetch(`https://api.unsplash.com/photos/${id}`, {
    headers: { Authorization: `Client-ID ${process.env.UNSPLASH_ACCESS_KEY}` },
  });
  return res.json();
}

export async function generateMetadata({ 
  params 
}: { 
  params: { id: string } 
}) {
  const photo = await getPhoto(params.id);
  
  return {
    title: `${photo.user.name}'s Photo - Gallery`,
    description: photo.description || 'View this amazing photo',
    openGraph: {
      images: [photo.urls.regular],
    },
  };
}

export default async function PhotoPage({ 
  params 
}: { 
  params: { id: string } 
}) {
  const photo = await getPhoto(params.id);
  
  return (
    <main className="container mx-auto p-8">
      <Link 
        href="/" 
        className="inline-flex items-center text-blue-600 mb-6"
      >
        ← Back to Gallery
      </Link>
      
      <div className="grid md:grid-cols-2 gap-8">
        <div>
          <img
            src={photo.urls.full}
            alt={photo.description || 'Photo'}
            className="w-full rounded-lg shadow-lg"
          />
        </div>
        
        <div>
          <div className="flex items-center gap-4 mb-6">
            <img
              src={photo.user.profile_image.medium}
              alt={photo.user.name}
              className="w-16 h-16 rounded-full"
            />
            <div>
              <h2 className="text-2xl font-bold">{photo.user.name}</h2>
              <p className="text-gray-600">@{photo.user.username}</p>
            </div>
          </div>
          
          {photo.description && (
            <div className="mb-6">
              <h3 className="font-semibold mb-2">Description</h3>
              <p className="text-gray-700">{photo.description}</p>
            </div>
          )}
          
          <div className="mb-6">
            <h3 className="font-semibold mb-2">Stats</h3>
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-gray-100 p-4 rounded">
                <p className="text-sm text-gray-600">Views</p>
                <p className="text-2xl font-bold">{photo.views?.toLocaleString()}</p>
              </div>
              <div className="bg-gray-100 p-4 rounded">
                <p className="text-sm text-gray-600">Downloads</p>
                <p className="text-2xl font-bold">{photo.downloads?.toLocaleString()}</p>
              </div>
            </div>
          </div>
          
          <div className="mb-6">
            <h3 className="font-semibold mb-2">Camera Info</h3>
            <div className="bg-gray-50 p-4 rounded">
              <p><strong>Camera:</strong> {photo.exif?.make} {photo.exif?.model}</p>
              <p><strong>Focal Length:</strong> {photo.exif?.focal_length}</p>
              <p><strong>Aperture:</strong> f/{photo.exif?.aperture}</p>
              <p><strong>ISO:</strong> {photo.exif?.iso}</p>
            </div>
          </div>
          
          <div className="flex gap-4">
            <button className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold">
              Like
            </button>
            <button className="flex-1 bg-gray-200 py-3 rounded-lg font-semibold">
              Download
            </button>
          </div>
        </div>
      </div>
      
      {/* Related Photos Section */}
      <div className="mt-12">
        <h3 className="text-2xl font-bold mb-6">More from {photo.user.name}</h3>
        <div className="grid grid-cols-4 gap-4">
          {/* Related photos grid */}
        </div>
      </div>
    </main>
  );
}

// app/@modal/default.tsx
export default function Default() {
  return null;
}
```

## 16. Advanced Use Cases

### 16.1. Multi-Step Form với Intercepting Routes

```
app/
├── @wizard/
│   ├── (..)checkout/
│   │   ├── step1/
│   │   │   └── page.tsx
│   │   ├── step2/
│   │   │   └── page.tsx
│   │   └── step3/
│   │       └── page.tsx
│   └── default.tsx
├── checkout/
│   ├── step1/
│   │   └── page.tsx
│   ├── step2/
│   │   └── page.tsx
│   └── step3/
│       └── page.tsx
├── cart/
│   └── page.tsx
└── layout.tsx
```

```tsx
// app/@wizard/(..)checkout/step1/page.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Modal } from '@/components/Modal';

export default function CheckoutStep1() {
  const router = useRouter();
  const [formData, setFormData] = useState({
    email: '',
    name: '',
  });
  
  const handleNext = () => {
    // Save to context or URL params
    router.push('/checkout/step2');
  };
  
  return (
    <Modal>
      <div className="max-w-md mx-auto">
        <h2 className="text-2xl font-bold mb-4">Checkout - Step 1 of 3</h2>
        <div className="mb-4 bg-gray-200 h-2 rounded">
          <div className="bg-blue-600 h-2 rounded" style={{ width: '33%' }} />
        </div>
        
        <form onSubmit={(e) => { e.preventDefault(); handleNext(); }}>
          <div className="mb-4">
            <label className="block mb-2">Email</label>
            <input
              type="email"
              className="w-full border p-2 rounded"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
            />
          </div>
          
          <div className="mb-4">
            <label className="block mb-2">Full Name</label>
            <input
              type="text"
              className="w-full border p-2 rounded"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
            />
          </div>
          
          <button 
            type="submit"
            className="w-full bg-blue-600 text-white py-2 rounded"
          >
            Continue to Shipping
          </button>
        </form>
      </div>
    </Modal>
  );
}
```

### 16.2. Contextual Actions với Intercepting Routes

```
app/
├── @action/
│   ├── (..)edit/
│   │   └── [id]/
│   │       └── page.tsx
│   ├── (..)delete/
│   │   └── [id]/
│   │       └── page.tsx
│   └── default.tsx
├── posts/
│   └── [id]/
│       └── page.tsx
└── layout.tsx
```

```tsx
// app/@action/(..)edit/[id]/page.tsx
import { Modal } from '@/components/Modal';
import { EditForm } from '@/components/EditForm';

async function getPost(id: string) {
  const res = await fetch(`https://api.example.com/posts/${id}`);
  return res.json();
}

export default async function EditPostModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  const post = await getPost(params.id);
  
  return (
    <Modal>
      <div className="max-w-2xl mx-auto">
        <h2 className="text-2xl font-bold mb-4">Edit Post</h2>
        <EditForm post={post} />
      </div>
    </Modal>
  );
}

// app/@action/(..)delete/[id]/page.tsx
'use client';

import { Modal } from '@/components/Modal';
import { useRouter } from 'next/navigation';

export default function DeletePostModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  const router = useRouter();
  
  const handleDelete = async () => {
    await fetch(`/api/posts/${params.id}`, { method: 'DELETE' });
    router.push('/posts');
  };
  
  return (
    <Modal>
      <div className="max-w-md mx-auto text-center">
        <h2 className="text-2xl font-bold mb-4">Delete Post?</h2>
        <p className="text-gray-600 mb-6">
          Are you sure you want to delete this post? This action cannot be undone.
        </p>
        <div className="flex gap-4">
          <button
            onClick={() => router.back()}
            className="flex-1 bg-gray-200 py-2 rounded"
          >
            Cancel
          </button>
          <button
            onClick={handleDelete}
            className="flex-1 bg-red-600 text-white py-2 rounded"
          >
            Delete
          </button>
        </div>
      </div>
    </Modal>
  );
}

// app/posts/[id]/page.tsx
import Link from 'next/link';

async function getPost(id: string) {
  const res = await fetch(`https://api.example.com/posts/${id}`);
  return res.json();
}

export default async function PostPage({ 
  params 
}: { 
  params: { id: string } 
}) {
  const post = await getPost(params.id);
  
  return (
    <article className="max-w-4xl mx-auto p-8">
      <h1 className="text-4xl font-bold mb-4">{post.title}</h1>
      <div className="flex gap-4 mb-8">
        <Link 
          href={`/edit/${params.id}`}
          className="px-4 py-2 bg-blue-600 text-white rounded"
        >
          Edit
        </Link>
        <Link 
          href={`/delete/${params.id}`}
          className="px-4 py-2 bg-red-600 text-white rounded"
        >
          Delete
        </Link>
      </div>
      <div className="prose">
        {post.content}
      </div>
    </article>
  );
}
```

### 16.3. Search Overlay với History

```
app/
├── @search/
│   ├── (..)search/
│   │   └── page.tsx
│   └── default.tsx
├── search/
│   └── page.tsx
└── layout.tsx
```

```tsx
// app/@search/(..)search/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Modal } from '@/components/Modal';

export default function SearchModal() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [query, setQuery] = useState(searchParams.get('q') || '');
  const [results, setResults] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  
  useEffect(() => {
    if (!query) return;
    
    const searchDebounce = setTimeout(async () => {
      setIsLoading(true);
      const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
      const data = await res.json();
      setResults(data);
      setIsLoading(false);
    }, 300);
    
    return () => clearTimeout(searchDebounce);
  }, [query]);
  
  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault();
    router.push(`/search?q=${encodeURIComponent(query)}`);
  };
  
  return (
    <Modal>
      <div className="max-w-2xl mx-auto">
        <form onSubmit={handleSearch} className="mb-6">
          <input
            type="search"
            placeholder="Search..."
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            className="w-full text-lg border-b-2 border-gray-300 focus:border-blue-600 outline-none p-2"
            autoFocus
          />
        </form>
        
        {isLoading && <div>Searching...</div>}
        
        {results.length > 0 && (
          <div>
            <h3 className="font-semibold mb-4">Results</h3>
            <ul className="space-y-2">
              {results.map((result: any) => (
                <li key={result.id}>
                  
                    href={result.url}
                    className="block p-3 hover:bg-gray-100 rounded"
                  >
                    <h4 className="font-semibold">{result.title}</h4>
                    <p className="text-sm text-gray-600">{result.excerpt}</p>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )}
        
        {query && !isLoading && results.length === 0 && (
          <div className="text-center text-gray-600">
            No results found for "{query}"
          </div>
        )}
      </div>
    </Modal>
  );
}

// app/search/page.tsx - Full Search Page
import { SearchResults } from '@/components/SearchResults';

async function search(query: string) {
  const res = await fetch(`https://api.example.com/search?q=${query}`);
  return res.json();
}

export default async function SearchPage({
  searchParams,
}: {
  searchParams: { q?: string };
}) {
  const query = searchParams.q || '';
  const results = query ? await search(query) : [];
  
  return (
    <main className="container mx-auto p-8">
      <h1 className="text-3xl font-bold mb-8">Search Results</h1>
      
      <form className="mb-8">
        <input
          type="search"
          name="q"
          defaultValue={query}
          placeholder="Search..."
          className="w-full max-w-2xl border-2 border-gray-300 rounded-lg p-4 text-lg"
        />
      </form>
      
      {results.length > 0 ? (
        <SearchResults results={results} />
      ) : (
        <p className="text-gray-600">No results found</p>
      )}
    </main>
  );
}
```

## 17. Error Handling và Edge Cases

### 17.1. Handling API Errors trong Modal

```tsx
// app/@modal/(..)photo/[id]/page.tsx
import { Modal } from '@/components/Modal';
import { notFound } from 'next/navigation';

async function getPhoto(id: string) {
  const res = await fetch(`https://api.example.com/photos/${id}`);
  
  if (!res.ok) {
    if (res.status === 404) {
      notFound();
    }
    throw new Error('Failed to fetch photo');
  }
  
  return res.json();
}

export default async function PhotoModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  const photo = await getPhoto(params.id);
  
  return (
    <Modal>
      <img src={photo.url} alt={photo.title} />
    </Modal>
  );
}

// app/@modal/(..)photo/[id]/error.tsx
'use client';

import { Modal } from '@/components/Modal';
import { useRouter } from 'next/navigation';

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  const router = useRouter();
  
  return (
    <Modal>
      <div className="text-center p-8">
        <h2 className="text-2xl font-bold mb-4">Something went wrong!</h2>
        <p className="text-gray-600 mb-6">{error.message}</p>
        <div className="flex gap-4 justify-center">
          <button
            onClick={() => router.back()}
            className="px-4 py-2 bg-gray-200 rounded"
          >
            Go Back
          </button>
          <button
            onClick={reset}
            className="px-4 py-2 bg-blue-600 text-white rounded"
          >
            Try Again
          </button>
        </div>
      </div>
    </Modal>
  );
}

// app/@modal/(..)photo/[id]/not-found.tsx
import { Modal } from '@/components/Modal';
import Link from 'next/link';

export default function NotFound() {
  return (
    <Modal>
      <div className="text-center p-8">
        <h2 className="text-2xl font-bold mb-4">Photo Not Found</h2>
        <p className="text-gray-600 mb-6">
          The photo you're looking for doesn't exist.
        </p>
        <Link 
          href="/"
          className="inline-block px-6 py-2 bg-blue-600 text-white rounded"
        >
          Back to Gallery
        </Link>
      </div>
    </Modal>
  );
}
```

### 17.2. Loading States

```tsx
// app/@modal/(..)photo/[id]/loading.tsx
import { Modal } from '@/components/Modal';

export default function Loading() {
  return (
    <Modal>
      <div className="flex items-center justify-center p-12">
        <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600" />
      </div>
    </Modal>
  );
}
```

### 17.3. Suspense Boundaries

```tsx
// app/@modal/(..)photo/[id]/page.tsx
import { Suspense } from 'react';
import { Modal } from '@/components/Modal';

async function PhotoContent({ id }: { id: string }) {
  const photo = await getPhoto(id);
  return <img src={photo.url} alt={photo.title} />;
}

async function PhotoComments({ id }: { id: string }) {
  const comments = await getComments(id);
  return (
    <div>
      {comments.map((comment: any) => (
        <div key={comment.id}>{comment.text}</div>
      ))}
    </div>
  );
}

export default function PhotoModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  return (
    <Modal>
      <Suspense fallback={<div>Loading photo...</div>}>
        <PhotoContent id={params.id} />
      </Suspense>
      
      <Suspense fallback={<div>Loading comments...</div>}>
        <PhotoComments id={params.id} />
      </Suspense>
    </Modal>
  );
}
```

## 18. Performance Optimization

### 18.1. Prefetching

```tsx
// app/page.tsx
import Link from 'next/link';

export default function Gallery() {
  return (
    <div className="grid grid-cols-3 gap-4">
      {photos.map((photo) => (
        <Link
          key={photo.id}
          href={`/photo/${photo.id}`}
          prefetch={true} // Prefetch modal content
        >
          <img src={photo.thumbnail} alt={photo.title} />
        </Link>
      ))}
    </div>
  );
}
```

### 18.2. Image Optimization

```tsx
// app/@modal/(..)photo/[id]/page.tsx
import Image from 'next/image';
import { Modal } from '@/components/Modal';

export default async function PhotoModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  const photo = await getPhoto(params.id);
  
  return (
    <Modal>
      <Image
        src={photo.url}
        alt={photo.title}
        width={1200}
        height={800}
        priority
        quality={90}
        placeholder="blur"
        blurDataURL={photo.blurDataUrl}
      />
    </Modal>
  );
}
```

### 18.3. Dynamic Imports

```tsx
// app/@modal/(..)video/[id]/page.tsx
import dynamic from 'next/dynamic';
import { Modal } from '@/components/Modal';

const VideoPlayer = dynamic(() => import('@/components/VideoPlayer'), {
  loading: () => <div>Loading player...</div>,
  ssr: false,
});

export default function VideoModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  return (
    <Modal>
      <VideoPlayer videoId={params.id} />
    </Modal>
  );
}
```

## 19. Accessibility Considerations

### 19.1. Focus Management

```tsx
// components/Modal.tsx
'use client';

import { useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';

export function Modal({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  const modalRef = useRef<HTMLDivElement>(null);
  const previousActiveElement = useRef<HTMLElement | null>(null);
  
  useEffect(() => {
    // Save current focus
    previousActiveElement.current = document.activeElement as HTMLElement;
    
    // Focus modal
    modalRef.current?.focus();
    
    // Restore focus on unmount
    return () => {
      previousActiveElement.current?.focus();
    };
  }, []);
  
  // Trap focus inside modal
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Tab') {
      const focusableElements = modalRef.current?.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      
      if (!focusableElements) return;
      
      const firstElement = focusableElements[0] as HTMLElement;
      const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement;
      
      if (e.shiftKey) {
        if (document.activeElement === firstElement) {
          lastElement.focus();
          e.preventDefault();
        }
      } else {
        if (document.activeElement === lastElement) {
          firstElement.focus();
          e.preventDefault();
        }
      }
    }
  };
  
  return (
    <div
      ref={modalRef}
      role="dialog"
      aria-modal="true"
      tabIndex={-1}
      onKeyDown={handleKeyDown}
      className="modal-overlay"
    >
      {children}
    </div>
  );
}
```

### 19.2. ARIA Attributes

```tsx
// app/@modal/(..)photo/[id]/page.tsx
import { Modal } from '@/components/Modal';

export default async function PhotoModal({ 
  params 
}: { 
  params: { id: string } 
}) {
  const photo = await getPhoto(params.id);
  
  return (
    <Modal>
      <div
        role="img"
        aria-label={photo.title}
        aria-describedby="photo-description"
      >
        <img src={photo.url} alt="" /> {/* Empty alt since aria-label is on parent */}
        <p id="photo-description" className="sr-only">
          {photo.description}
        </p>
      </div>
      
      <button
        aria-label="Close modal"
        onClick={() => router.back()}
      >
        ×
      </button>
    </Modal>
  );
}
```

## 20. Kết Luận

### Tóm tắt Key Points

**Intercepting Routes** là một tính năng mạnh mẽ cho phép:

✅ **Deep linkable modals**: URL shareable, SEO-friendly  
✅ **Context preservation**: Giữ nguyên state của page hiện tại  
✅ **Better UX**: Smooth transitions, faster navigation  
✅ **Server Components**: Full support cho streaming và data fetching  
✅ **Flexible routing**: Multiple interception points, conditional logic

### Khi nào nên sử dụng

**✅ Sử dụng khi:**
- Cần modal với deep links (photo galleries, product quick views)
- Multi-step flows mà vẫn muốn shareable URLs
- Contextual actions (edit, delete) từ list views
- Login/signup overlays

**❌ Không nên sử dụng khi:**
- Simple modals không cần URLs
- Pure client-side interactions
- Complexity không justify benefits
- Performance-critical applications với nhiều nested routes

### Best Practices Checklist

- [ ] Luôn implement cả intercepted và full page versions
- [ ] Tạo `default.tsx` cho tất cả parallel routes
- [ ] Handle errors và loading states properly
- [ ] Implement keyboard navigation (Escape key)
- [ ] Focus management cho accessibility
- [ ] Test cả soft navigation và hard refresh
- [ ] Optimize images và heavy components
- [ ] Document routing structure rõ ràng

### Resources

- [Next.js Documentation - Intercepting Routes](https://nextjs.org/docs/app/building-your-application/routing/intercepting-routes)
- [Next.js Documentation - Parallel Routes](https://nextjs.org/docs/app/building-your-application/routing/parallel-routes)
- [Vercel Examples - Photo Gallery](https://github.com/vercel/next.js/tree/canary/examples/app-dir-mdx)

Intercepting Routes mở ra nhiều possibilities cho việc tạo modern, user-friendly web applications với Next.js! 🚀
---


[<< BÀI 28](./28.md) | [BÀI 30 >>](./30.md)