# Javascript worker
<details>
<summary><strong>1. JavaScript Web Worker API</strong></summary>

### 1. Web Worker l√† g√¨?

* JavaScript **ch·∫°y ƒë∆°n lu·ªìng**, nghƒ©a l√† n·∫øu th·ª±c hi·ªán **t√°c v·ª• n·∫∑ng tr√™n main thread**, giao di·ªán web c√≥ th·ªÉ b·ªã **ƒë∆°**.
* **Web Worker** l√† c∆° ch·∫ø cho ph√©p **ch·∫°y JavaScript ·ªü background** m√† kh√¥ng ·∫£nh h∆∞·ªüng t·ªõi giao di·ªán ch√≠nh.
* Worker v√† main thread giao ti·∫øp b·∫±ng **message**, th√¥ng qua `postMessage()` v√† `onmessage`.

**L·ª£i √≠ch:** l√†m trang web m∆∞·ª£t m√† h∆°n khi x·ª≠ l√Ω c√°c t√°c v·ª• n·∫∑ng.

---

### 2. Ki·ªÉm tra tr√¨nh duy·ªát h·ªó tr·ª£ Web Worker

```js
if (typeof Worker !== "undefined") {
  console.log("H·ªó tr·ª£ Web Worker");
} else {
  console.log("Kh√¥ng h·ªó tr·ª£ Web Worker");
}
```

---

### 3. T·∫°o file JavaScript cho Worker

`web_worker.js`

```js
for (var i = 0; i < 10000000000; i++) {
  if (i % 1000000000 === 0) postMessage(i);
}

self.onmessage = function(msg) {
  // X·ª≠ l√Ω message t·ª´ main thread
};
```

---

### 4. Kh·ªüi t·∫°o Web Worker

```js
var w;

function startWorker() {
  if (typeof Worker !== "undefined") {
    if (typeof w === "undefined") {
      w = new Worker("web_worker.js");
    }

    w.onmessage = function(event) {
      console.log("Message from worker:", event.data);
    };

    w.onerror = function(err) {
      console.error("Worker error:", err);
    };
  } else {
    console.log("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Worker");
  }
}
```

* **`Worker.onmessage`**: nh·∫≠n message t·ª´ worker.
* **`Worker.onerror`**: nh·∫≠n l·ªói t·ª´ worker.

---

### 5. D·ª´ng Web Worker

```js
w.terminate(); // Ng·ª´ng worker
```

---

### 6. Giao ti·∫øp gi·ªØa main thread v√† worker

#### a) `postMessage()` v·ªõi d·ªØ li·ªáu th√¥ng th∆∞·ªùng

* **Main thread g·ª≠i:**

```js
myWorker.postMessage({ cmd: "start", msg: "hello" });
```

* **Worker nh·∫≠n:**

```js
self.onmessage = function(event) {
  console.log(event.data.cmd, event.data.msg);
  if(event.data.cmd === "start") {
    // x·ª≠ l√Ω task
    postMessage({ cmd: "resp", msg: "done" });
  }
};
```

**Nh∆∞·ª£c ƒëi·ªÉm:** d·ªØ li·ªáu l·ªõn ƒë∆∞·ª£c **copy**, t·ªën b·ªô nh·ªõ.

---

#### b) S·ª≠ d·ª•ng **Transferable Object**

* D·ªØ li·ªáu ƒë∆∞·ª£c **chuy·ªÉn quy·ªÅn s·ªü h·ªØu**, kh√¥ng copy ‚Üí ti·∫øt ki·ªám b·ªô nh·ªõ.

**Main thread:**

```js
var arrBuf = new ArrayBuffer(1000);

myWorker.postMessage({ buf: arrBuf }, [arrBuf]);

console.log(arrBuf.byteLength); // 0 sau khi transfer
```

**Worker:**

```js
self.onmessage = function(event) {
  console.log(event.data.buf.byteLength); // 1000
};
```

* Transferable Object ph·ªï bi·∫øn: `ArrayBuffer`, `MessagePort`.

---

### 7. L∆∞u √Ω

* Message ƒë∆∞·ª£c x·ª≠ l√Ω **tu·∫ßn t·ª±**, theo th·ª© t·ª± g·ª≠i.
* Worker c√≥ th·ªÉ **t·ª± ƒë√≥ng** b·∫±ng `self.close()`.
* S·ª≠ d·ª•ng Worker cho c√°c **t√°c v·ª• n·∫∑ng, t√≠nh to√°n l·ªõn**, tr√°nh l√†m UI ƒë∆°.

---

### 8. Tham kh·∫£o

* [HTML5 Web Worker](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers)
* [Using Web Worker](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers)
* [Web Worker Transferable Objects](https://developer.mozilla.org/en-US/docs/Web/API/Transferable)

</details>
<details>
<summary><strong>2. JavaScript Service Worker</strong></summary>

### 1. Service Worker l√† g√¨?

* L√† m·ªôt **script ch·∫°y ·ªü background**, t√°ch kh·ªèi trang web.
* Kh√¥ng li√™n k·∫øt v·ªõi m·ªôt trang c·ª• th·ªÉ, **kh√¥ng truy c·∫≠p DOM**, c√≥ th·ªÉ **d·ª´ng khi kh√¥ng c·∫ßn** v√† **ch·ªâ ch·∫°y khi c·∫ßn thi·∫øt**.
* Ch·ªâ ho·∫°t ƒë·ªông tr√™n **HTTPS**.

**T√≠nh nƒÉng ch√≠nh:**

* Gi√∫p **trang web ch·∫°y nhanh h∆°n** v√† c√≥ th·ªÉ **offline**.
* X·ª≠ l√Ω c√°c t√°c v·ª• **background**: push notifications, background sync.

---

### 2. ƒêƒÉng k√Ω Service Worker

**C·∫•u tr√∫c t·ªáp:**

```
index.html
service_worker.js
main.js
style.css
```

**main.js**

```js
if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("service_worker.js")
    .then(reg => console.log("Registered service worker"))
    .catch(err => console.log("Register failed", err));
}
```

**L∆∞u √Ω:**

* File `service_worker.js` quy·∫øt ƒë·ªãnh URL m√† n√≥ qu·∫£n l√Ω.
* `.register()` tr·∫£ v·ªÅ **Promise**.
* Trang web ph·∫£i **HTTPS** v√† **same origin**.

---

### 3. Install Service Worker

**service\_worker.js**

```js
const PRECACHE = "my-precache-v1";
const RUNTIME = "my-runtime";
const PRECACHE_URLS = [
  "index.html",
  "./",
  "style.css",
  "main.js"
];

self.addEventListener("install", event => {
  event.waitUntil(
    caches.open(PRECACHE)
      .then(cache => cache.addAll(PRECACHE_URLS))
      .then(self.skipWaiting())
  );
});
```

* M·ª•c ƒë√≠ch: l∆∞u **resources c·∫ßn thi·∫øt** v√†o cache.
* `self.skipWaiting()`: d·ª´ng install v√† chuy·ªÉn sang b∆∞·ªõc activate.

---

### 4. Activate Service Worker

```js
self.addEventListener("activate", event => {
  const currentCaches = [PRECACHE, RUNTIME];
  event.waitUntil(
    caches.keys()
      .then(cacheNames => cacheNames.filter(cacheName => !currentCaches.includes(cacheName)))
      .then(cachesToDelete => Promise.all(cachesToDelete.map(cacheToDelete => caches.delete(cacheToDelete))))
      .then(() => self.clients.claim())
  );
});
```

* X√≥a **cache c≈©** v√† gi·ªØ cache m·ªõi.
* `self.clients.claim()`: k√≠ch ho·∫°t Service Worker ngay l·∫≠p t·ª©c.

**C·∫≠p nh·∫≠t resources m·ªõi:**

* Thay ƒë·ªïi t√™n PRECACHE ‚Üí Service Worker s·∫Ω x√≥a cache c≈©.

---

### 5. Fetch Handler

```js
self.addEventListener("fetch", event => {
  if (event.request.url.startsWith(self.location.origin)) {
    event.respondWith(
      caches.match(event.request).then(cachedResponse => {
        if (cachedResponse) return cachedResponse;

        return caches.open(RUNTIME).then(cache =>
          fetch(event.request).then(response => {
            cache.put(event.request, response.clone());
            return response;
          })
        );
      })
    );
  }
});
```

**√ù nghƒ©a:**

1. B·ªè qua request **cross-origin**.
2. N·∫øu c√≥ **cache**, tr·∫£ v·ªÅ ngay.
3. N·∫øu kh√¥ng, fetch t·ª´ server, l∆∞u v√†o **RUNTIME cache**, r·ªìi tr·∫£ v·ªÅ.

* Service Worker ƒë·∫£m nh·∫≠n **offline resources** v√† **ƒë·ªãnh tuy·∫øn requests**.

---

### 6. T·ªïng k·∫øt

* **Install & Activate** ‚Üí l∆∞u resources v√†o cache.
* **Fetch** ‚Üí ƒë·ªãnh tuy·∫øn v√† ph·ª•c v·ª• offline.
* Service Worker gi√∫p web **nhanh h∆°n**, **offline**, v√† **background tasks**.

---

### 7. Tham kh·∫£o

* [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
* [Using Service Workers](https://developers.google.com/web/fundamentals/primers/service-workers)
* [Service Workers: an Introduction](https://developers.google.com/web/ilt/pwa/introduction-to-service-worker)

### 8. C√¢u h·ªèi 

## **1. Service Worker l√† g√¨?**

* **Service Worker (SW)** l√† m·ªôt file JavaScript ch·∫°y **t√°ch bi·ªát kh·ªèi main thread** c·ªßa tr√¨nh duy·ªát.
* N√≥ **kh√¥ng can thi·ªáp tr·ª±c ti·∫øp v√†o DOM** nh∆∞ng c√≥ th·ªÉ l·∫Øng nghe c√°c s·ª± ki·ªán m·∫°ng (fetch), push notification, background sync,...
* Nhi·ªám v·ª• ch√≠nh:

  1. **Cache d·ªØ li·ªáu & offline** ‚Üí gi√∫p ·ª©ng d·ª•ng ch·∫°y ƒë∆∞·ª£c khi kh√¥ng c√≥ Internet.
  2. **Intercept request** ‚Üí ki·ªÉm so√°t m·∫°ng, c√≥ th·ªÉ tr·∫£ v·ªÅ d·ªØ li·ªáu cache ho·∫∑c fetch t·ª´ server.
  3. **Background task** ‚Üí nh·∫≠n notification, sync d·ªØ li·ªáu ng·∫ßm.

**L∆∞u √Ω:** SW ch·ªâ ch·∫°y tr√™n **HTTPS** (tr·ª´ localhost), v√¨ n√≥ c·∫ßn b·∫£o m·∫≠t.

---

## **2. V√≤ng ƒë·ªùi c·ªßa Service Worker**

V√≤ng ƒë·ªùi c·ªßa Service Worker kh√° kh√°c so v·ªõi JavaScript th√¥ng th∆∞·ªùng, bao g·ªìm **4 giai ƒëo·∫°n ch√≠nh**: **Register ‚Üí Install ‚Üí Activate ‚Üí Fetch/Idle**.

### **2.1. Register (ƒêƒÉng k√Ω)**

* SW ƒë∆∞·ª£c **kh·ªüi t·∫°o t·ª´ web app** b·∫±ng `navigator.serviceWorker.register('/sw.js')`.
* Tr√¨nh duy·ªát s·∫Ω **t·∫£i file SW** v√† chu·∫©n b·ªã c√†i ƒë·∫∑t.
* V√≠ d·ª•:

```javascript
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(reg => console.log('Service Worker registered', reg))
    .catch(err => console.log('SW registration failed', err));
}
```

---

### **2.2. Install (C√†i ƒë·∫∑t)**

* Khi SW ƒë∆∞·ª£c t·∫£i, n√≥ b∆∞·ªõc v√†o giai ƒëo·∫°n **install**.
* Th∆∞·ªùng d√πng ƒë·ªÉ **cache c√°c t√†i nguy√™n tƒ©nh** (HTML, CSS, JS, images,...)
* N·∫øu install th·∫•t b·∫°i (v√≠ d·ª• cache b·ªã l·ªói), SW s·∫Ω kh√¥ng ƒë∆∞·ª£c k√≠ch ho·∫°t.
* V√≠ d·ª• trong `sw.js`:

```javascript
self.addEventListener('install', event => {
  console.log('Service Worker installing...');
  event.waitUntil(
    caches.open('v1').then(cache => {
      return cache.addAll([
        '/',
        '/index.html',
        '/styles.css',
        '/app.js'
      ]);
    })
  );
});
```

> `event.waitUntil()`: gi·ªØ SW ·ªü tr·∫°ng th√°i install cho ƒë·∫øn khi promise ho√†n t·∫•t.

---

### **2.3. Activate (K√≠ch ho·∫°t)**

* Sau khi install th√†nh c√¥ng, SW b∆∞·ªõc v√†o **activate**.
* Giai ƒëo·∫°n n√†y th∆∞·ªùng d√πng ƒë·ªÉ **d·ªçn d·∫πp cache c≈©**, chu·∫©n b·ªã SW m·ªõi qu·∫£n l√Ω ·ª©ng d·ª•ng.
* V√≠ d·ª•:

```javascript
self.addEventListener('activate', event => {
  console.log('Service Worker activated');
  event.waitUntil(
    caches.keys().then(keys => {
      return Promise.all(
        keys.filter(key => key !== 'v1')
            .map(key => caches.delete(key))
      );
    })
  );
});
```

---

### **2.4. Fetch (Ch·∫∑n request)**

* SW gi·ªù ƒë√£ **ho·∫°t ƒë·ªông v√† qu·∫£n l√Ω m·∫°ng**.
* B·∫•t k·ª≥ request t·ª´ web page (HTML, API, images...) ƒë·ªÅu ƒëi qua SW.
* T·∫°i ƒë√¢y c√≥ th·ªÉ tr·∫£ v·ªÅ d·ªØ li·ªáu t·ª´ cache ho·∫∑c fetch t·ª´ network.
* V√≠ d·ª• cache-first strategy:

```javascript
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(response => {
      return response || fetch(event.request);
    })
  );
});
```

---

### **T√≥m t·∫Øt v√≤ng ƒë·ªùi**

| Giai ƒëo·∫°n      | M·ª•c ƒë√≠ch ch√≠nh                                   |
| -------------- | ------------------------------------------------ |
| **Register**   | ƒêƒÉng k√Ω SW v·ªõi tr√¨nh duy·ªát                       |
| **Install**    | Cache t√†i nguy√™n tƒ©nh, chu·∫©n b·ªã offline          |
| **Activate**   | X√≥a cache c≈©, chu·∫©n b·ªã SW m·ªõi                    |
| **Fetch/Idle** | Ch·∫∑n request, tr·∫£ d·ªØ li·ªáu offline, nh·∫≠n push,... |

---

üí° **L∆∞u √Ω quan tr·ªçng:**

1. SW **ch·ªâ ch·∫°y khi trang ƒë∆∞·ª£c load l·∫ßn ƒë·∫ßu**, kh√¥ng t·ª± ƒë·ªông ch·∫°y tr√™n t·∫•t c·∫£ tab.
2. SW **l∆∞u tr·ªØ l√¢u d√†i**, tr√¨nh duy·ªát qu·∫£n l√Ω version. Khi SW m·ªõi xu·∫•t hi·ªán, tr√¨nh duy·ªát s·∫Ω **install nh∆∞ng ch∆∞a activate** n·∫øu c√≤n tab c≈© ƒëang d√πng SW c≈©.
3. SW **kh√¥ng c√≥ quy·ªÅn DOM**, n√™n ch·ªâ thao t√°c cache, fetch, push, sync,...




</details>
